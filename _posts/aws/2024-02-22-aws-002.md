---
layout: post
date: 2024-02-22
catalogue: "AWS"
subject: "AWS"
title: "AWS SDK 개발 환경 구축"
excerpt: "AWS 개발을 위한 SDK 사용방법"
author: tiaz
permalink: /AWS/2
tags: [AWS, AWS SDK]
---

`AWS CLI`, `AWS SDK`를 사용해서 AWS 서비스를 이용하는 개발 환경을 구축해보도록 하겠습니다.

## 임시 자격 증명(Assume-Role)

---

개발시 사용하는 AWS 자격증명은 크게 두가지가 있습니다.

- Access key
- AssumeRole

`Access key`를 사용하는 경우는 유출시 치명적이므로, 반드시 `AssumeRole`을 이용해서 토큰을 발급받아 사용합시다. Assume의 대상인 역할(Role) 또한 필요한 최소 권한만 설정하는게 바람직합니다.

## AWS를 이용하는 방법

---

AWS를 이용하는 방법에는 크게 3가지 방법이 있습니다. 여기에서는 실제 웹에서 로그인하는 `AWS console` 방식을 제외하고 `AWS CLI`, `AWS SDK` 를 이용하고 공부하는 방법에 대해서 알아보겠습니다. 또한 개발 환경에 맞게 세팅하는 방법에 대해서 알아보겠습니다.

### AWS CLI

[AWS Command Line Interface
버전 2 사용 설명서](https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/cli-chap-welcome.html)
를 보고 

[AWS CLI Command Reference](https://docs.aws.amazon.com/cli/latest)

### AWS SDK

- [Boto3 documentation](https://boto3.amazonaws.com/v1/documentation/api/latest/index.html)
- [AWS SDK Code Examples](https://github.com/awsdocs/aws-doc-sdk-examples)

## aws-cli 설치

```bash
$ apt update

$ apt install awscli jq
```

## aws-cli configure

```bash
$ aws configure
```

```text
AWS Access Key ID [None] :
AWS Secret Access Key [None] :
Default region name [None] : ap-northeast-2
Default output format [None] : None
```

## aws-cli Assume-Role

```bash
$ aws sts assume-role --role-arn <ROLE_ARN> --role-session-name <test-session>
```

```text
{
    "Credentials": {
        "AccessKeyId": "ASIA.......",
        "SecretAccessKey": "YwyGY8dF5.......",
        "SessionToken": "IQoJb3JpZ2.......",
        "Expiration": "2024-04-21T08:08:12Z"
    },
    "AssumedRoleUser": {
        "AssumedRoleId": "AROA6Q5UMFQN.......",
        "Arn": "arn:aws:......."
    }
}
```

발급 받은 임시 자격 증명(Assume-Role) `Credentials` 토큰을 환경 변수로 세팅

- `Credentials.AccessKeyId`
- `Credentials.SecretAccessKey`
- `Credentials.SessionToken`

```bash
export AWS_ACCESS_KEY_ID=
export AWS_SECRET_ACCESS_KEY=
export AWS_SESSION_TOKEN=
```

## aws-cli Assume-Role 스크립트

위의 작업을 bash 스크립트로 작성해두고 실행하자.

```bash
$ export ROLE_ARN=

$ source ./scripts/set_assume_role.sh
```

```bash
$ aws sts get-caller-identity
```

## boto3 Assume-Role

- `.env` 파일에 필요한 정보를 입력
- pytest fixture 로 임시 자격 증명(Assume-Role) `Credentials` 토큰을 발급 받아서 테스트

```text
AWS_ACCOUNT_ID=
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
REGION_NAME=ap-northeast-2

ROLE_ARN=
```

```python
def assume_role(aws_user_session: Session, role_arn):
    sts_client = aws_user_session.client("sts")

    response = sts_client.assume_role(
        RoleArn=role_arn, RoleSessionName="boto3-assume-session"
    )

    return response["Credentials"]
```
