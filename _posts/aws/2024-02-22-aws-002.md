---
layout: post
date: 2024-02-22
catalogue: "AWS"
subject: "AWS"
title: "AWS SDK 개발 환경 구축"
excerpt: "AWS 개발을 위한 SDK 사용방법"
author: tiaz
permalink: /AWS/2
tags: [AWS, AWS SDK]
---

`AWS CLI`, `AWS SDK`를 사용해서 개발 환경을 구축해보도록 하겠습니다.

## AWS를 이용하는 방법

---

AWS를 이용하는 방법에는 크게 3가지 방법이 있습니다. 여기에서는 실제 웹에서 로그인하는 `AWS console` 방식을 제외하고 `AWS CLI`, `AWS SDK` 를 이용하고 공부하는 방법에 대해서 알아보겠습니다. 또한 개발 환경에 맞게 세팅하는 방법에 대해서 알아보겠습니다.

## 임시 자격 증명(AssumeRole)

---

개발시 사용하는 AWS 자격증명은 크게 두가지가 있습니다.

- Access key
- AssumeRole

`Access key`를 사용하는 경우는 유출시 치명적이므로, 반드시 `AssumeRole`을 이용해서 토큰을 발급받아 사용합시다. Assume의 대상인 역할(Role) 또한 필요한 최소 권한만 설정하는게 바람직합니다.

## AWS CLI : AssumeRole

AWS CLI에서 아래의 명령을 통해 JSON 형태의 토큰을 발급 받을 수 있습니다. 하지만 토큰을 받아서 다시 그 토큰을 환경변수에 등록하기는 무척이나 번거롭습니다. 게다가 토큰의 최대 만료시간은 12시간이기 때문에 필요할때마다 매번 해당 작업을 반복해야 합니다.

```bash
$ aws sts assume-role --role-arn <ROLE_ARN> --role-session-name <session-name>
```

```text
{
    "Credentials": {
        "AccessKeyId": "ASIA.......",
        "SecretAccessKey": "YwyGY8dF5.......",
        "SessionToken": "IQoJb3JpZ2.......",
        "Expiration": "2024-04-21T08:08:12Z"
    },
}
```

## AssumeRole 스크립트 작성

---

AssumeRole에서 필요한 3가지 값은 다음과 같습니다. 이 값들을 자동으로 환경변수에 등록하는 스크립트를 작성해봅시다.

- `Credentials.AccessKeyId`
- `Credentials.SecretAccessKey`
- `Credentials.SessionToken`

JSON 데이터를 처리하는 `jq` 패키지를 설치하고 스크립트를 작성합니다. `$()`는 쉘 스크립트에서 명령어 치환(Command Substitution)을 위해 사용되는 구문입니다. 이 구문은 괄호 안의 명령어를 실행하고, 그 결과를 출력합니다.

`$ROLE_ARN` 환경변수는 해당 스크립트가 실행 될때 원하는 역할(Role)을 입력 받을 수 있게 만들어둡니다.

`jq -r` 옵션은 출력을 raw 문자열로 반환하라는 의미입니다. 기본적으로 jq는 JSON 문자열 형태로 따옴표로 둘러싸여 있습니다. 하지만 `-r` 옵션을 사용하면, 따옴표 없이 raw 문자열을 출력합니다. 따옴표 없는 raw 형태의 토큰을 `export` 를 수행해서 환경변수에 등록 합니다.

```bash
$ apt install jq
```

```text
#!/bin/bash

output=$(aws sts assume-role --role-arn $ROLE_ARN --role-session-name cli-assume-session)

export AWS_ACCESS_KEY_ID=$(echo $output | jq -r '.Credentials.AccessKeyId')
export AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r '.Credentials.SecretAccessKey')
export AWS_SESSION_TOKEN=$(echo $output | jq -r '.Credentials.SessionToken')
```

실행할때는 `ROLE_ARN` 환경변수에 원하는 역할 ARN 값을 입력합니다.

```bash
$ export ROLE_ARN=

$ source ./scripts/set_assume_role.sh
```

```bash
$ aws sts get-caller-identity
```

디버그 로깅을 활성화하는 boolean 스위치입니다. 기본적으로 AWS CLI는 명령 출력의 명령 결과와 관련된 성공 또는 실패에 대한 정리 정보를 제공합니다. 전체 Python 로그를 제공합니다.

여기에는 해당 명령의 작동에 대한 추가적인 stderr 진단 정보가 포함되어 있는데, 이는 명령이 예기치 않은 결과를 제공하는 이유를 해결할 때 유용할 수 있습니다. 디버그 로그를 쉽게 보려면 정보를 쉽게 검색할 수 있도록 로그를 파일로 보내는 것이 좋습니다. 이를 위해 다음 중 하나를 사용할 수 있습니다.

stderr 진단 정보만 보내려면 `2> 파일명`
출력과 stderr 진단 정보둘 다 보내려면 `&> 파일명`

```bash
aws servicename commandname options --debug 2> debug.txt

aws servicename commandname options --debug &> debug.txt
```

## AWS SDK : AssumeRole

- `.env` 파일에 필요한 정보를 입력
- pytest fixture 로 임시 자격 증명(AssumeRole) `Credentials` 토큰을 발급 받아서 테스트

```text
AWS_ACCOUNT_ID=
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
REGION_NAME=ap-northeast-2

ROLE_ARN=
```

```python
def assume_role(aws_user_session: Session, role_arn):
    sts_client = aws_user_session.client("sts")

    response = sts_client.assume_role(
        RoleArn=role_arn, RoleSessionName="boto3-assume-session"
    )

    return response["Credentials"]
```

### AWS CLI

- [AWS CLI Command Reference](https://docs.aws.amazon.com/cli/latest)

### AWS SDK

- [Boto3 documentation](https://boto3.amazonaws.com/v1/documentation/api/latest/index.html)
- [AWS SDK Code Examples](https://github.com/awsdocs/aws-doc-sdk-examples)
