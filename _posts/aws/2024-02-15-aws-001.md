---
layout: post
date: 2024-02-15
catalogue: "AWS"
subject: "AWS"
title: "AWS 임시 자격 증명(Assume-Role)"
excerpt: "AWS 자격 증명과 Assume-Role"
author: tiaz
permalink: /AWS/1
tags: [AWS, Assume-Role]
---

AWS 자격 증명에 대해서 알아보고 Assume-Role 에 대해서 알아보겠습니다.

## AWS 자격 증명

---

AWS에서 자격 증명은 사용자나 서비스가 AWS 리소스에 액세스하는 데 필요한 보안 자격 증명을 의미합니다. AWS에서는 다음과 같은 종류의 자격 증명을 사용합니다.

### 비밀번호 + MFA

- AWS Console에 로그인하는 데 사용되는 사용자 이름과 비밀번호
- 멀티 팩터 인증(MFA)는 OTP 앱과 같이 다른 기기를 통해 추가 인증하는 방식

![MFA](/assets//img/content/AWS/001/002.png){:.img-l}

`> IAM 사용자 MFA`{:.img-caption}

### 키 페어

- Amazon EC2 인스턴스에 SSH 접속시 사용되는 공개 키와 개인 키의 쌍

![EC2 키 페어](/assets//img/content/AWS/001/003.png){:.img-l}

`> EC2 키 페어`{:.img-caption}

### Access key

- Access key는 AWS CLI, AWS SDK 와 같은 프로그래밍 방식으로 AWS를 액세스하는 데 사용
- Access key는 Access key ID와 Secret access key의 두 부분으로 구성
- 생성 후에는 다시 키 정보를 확인 할 수 없고 재발급 해야하며, 한 번에 최대 두 개의 키를 사용 할 수 있습니다.

### 임시 보안 토큰 (Temporary Security Tokens)

- 일시적 보안 자격 증명을 제공하는 데 사용되는 토큰
- 일반적으로 AWS Security Token Service (STS)의 `Assume-Role` API 작업을 통해 발급

## Access key 와 장기 자격 증명

---

여러가지 자격 증명 중에서 실제 개발과 관련된 작업에서는 주로 Access key와 임시 보안 토큰이 사용됩니다.

`Access key` 방식은 IAM 유저로 부터 생성되며 유저의 권한을 그대로 상속 받습니다. 생성 시 만료 기간 없이 계속해서 사용 할 수 있는 장기 자격 증명(Long-Term Credential) 방식을 이용 합니다. 만료 기간이 없기 때문에 간편하게 사용 할 수 있다는 장점이 있습니다.

하지만 여기서 만료 기간이 없는 키를 장기간 사용하게 되면서 관리가 소흘해지고 보안 취약점이 되는 경우가 많습니다. 대표적인 예를 봅시다.

1. 키 정보가 git 에 commit 되어 공개 된다거나
2. Access key 발급시 보관하던 키 정보가 공유 된다거나

이처럼 만료 기간이 없는 Access key가 유출되면 해당 IAM 유저의 모든 권한을 그대로 행사 가능해지는 위험이 존재합니다.

## 임시 보안 토큰과 Assume-Role

---

임시 보안 토큰은 사용 기간이 정해져 있는 토큰을 사용하는 방식 입니다. 필요시 동적으로 생성하여 사용할 수 있기 때문에 **관리가 용이하며 보안적 더 뛰어납니다.**{:.orange}

임시 보안 토큰을 발급 받는 방법은 AWS Security Token Service(STS)를 통해서 토큰을 발급 받는 `Assume-Role` 방식이 있습니다.

Assume-Role은 다른 역할(Role)을 수행 할 수 있게 해줍니다. 이를 통해 필요한 작업을 수행하고, 작업이 끝나면 원래의 권한으로 돌아갈 수 있습니다.

<div class="youtube">
    <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/pLlX-uxhsXg?si=k_ecMn6_FCrWzQwn" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>

`> AWS 강의실 : 장기 자격 증명 vs 임시 자격 증명`{:.img-caption}

## 유저 생성 및 Access key 발급

---

### 1. 사용자 생성

`Identity and Access Management(IAM)`을 이용한 유저 생성과 개발에 사용할 Access key 발급을 받아보겠습니다. `IAM` - `사용자` - `사용자 생성`을 선택합니다.

![Switching to a role (console)](/assets//img/content/AWS/001/006.png){:.img-l}

`> IAM 서비스에서 사용자 메뉴를 선택 - 사용자 생성`{:.img-caption}

### 2. 권한 추가

**직접 정책 연결을 선택하고 `AmazonEC2FullAccess` 검색해서 체크합니다.** 생성하는 사용자는 EC2에 관련된 권한 전체를 부여한다는 뜻입니다. 그럼 나머지 S3와 같은 다른 서비스는 권한이 없기 때문에 사용 할 수 없습니다. 이렇게 일반적으로 필요한 권한만 부여하고 관리하는 방식으로 운영합니다.

![Switching to a role (console)](/assets//img/content/AWS/001/007.png){:.img-l}

`> 권한 추가`{:.img-caption}

### 3. Access key 발급

생성한 유저를 선택하고 `보안 자격 증명` 탭에서 Access key를 발급 할 수 있습니다. 해당 키는 현재 유저의 권한을 동일하게 갖게되는 키입니다. 따라서 앞서 유저에서 지정한 `AmazonEC2FullAccess` 권한을 가지게 됩니다. 유저 마다 Access key는 최대 2개까지 할당 가능합니다.

![Switching to a role (console)](/assets//img/content/AWS/001/008.png){:.img-l}

`> 액세스 키 만들기`{:.img-caption}

액세스 키 모범 사례 및 대안 이라는 선택 창이 나오는데 크게 중요하지 않고 `Command Line Interface(CLI)` 를 선택하고 하단에 계속하기 체크하고 다음으로 넘어가 **액세스 키 만들기** 버튼을 클릭합니다. 그럼 Access key가 생성됩니다.

Access key는 두 가지 키값을 가집니다.

- 액세스 키
- 비밀 액세스 키

액세스 키는 발급 이후 다시 확인이 가능하며 공개되어도 무방합니다. 하지만 **비밀 액세스 키는 절대 공개해서는 안됩니다. Access key는 할당 유저와 동일한 권한을 갖게 되기 때문에 반드시 사용시 관리에 신경을 써야합니다.** 더욱이 액세키는 장기 자격 증명 방식으로 한번 유출되면 키를 비활성화 또는 삭제 전까지 해당 키를 사용할 수 있기 때문에 각별히 주의해야 합니다.

비밀 액세스 키는 생성 후에 다시 확인 불가하기 때문에 분실시 다시 키를 생성 해야합니다. 두 가지 키값을 개인적인 공간에 잘 기록해둡니다. 필요한 경우 .csv 파일로 다운받아서 보관합니다.

![Switching to a role (console)](/assets//img/content/AWS/001/009.png){:.img-l}

`> Access key는 액세스 키, 비밀 액세스 키 로 구성된다.`{:.img-caption}

## AWS CLI(Command Line Interface) 사용해보기

---

이제 발급받은 Access key를 이용해서 AWS CLI를 사용해보겠습니다. `Ubuntu` 환경에서 진행하며 Windows 사용자의 경우 [AWS Command Line Interface](https://aws.amazon.com/ko/cli/) 링크에서 파일을 다운받아 설치합니다. 또는 [WSL 개발 환경을 구축](/tool/1) 해보길 추천합니다.

```bash
$ sudo apt update

$ sudo apt install awscli

$ aws --version
```

설치가 끝나면 이제 앞서 발급한 Access key를 등록해야 해당 유저로 AWS 서비스를 이용할 수 있습니다. `aws configure` 명령을 통해 Access key를 등록할 수 있습니다. `Default region name` 입력에서는 서울 리전 `ap-northeast-2`를 입력합니다. `Default output format` 에서 그대로 엔터를 누릅니다.

```bash
$ aws configure
```

```text
AWS Access Key ID [None] : 발급받은 액서스키
AWS Secret Access Key [None] : 발급받은 비밀 액세스 키
Default region name [None] : ap-northeast-2
Default output format [None] : 
```

## Assume-Role 따라해보기

---

이번에는 앞서 생성한 유저에 sts assume-role 권한을 부여해보고 동적으로 다른 역활(Role)로 변경해 토큰을 발급는 임시 자격 증명 방식을 사용해 보도록 하겠습니다.

### 1. 유저 Assume-Role 권한 부여

### 2. 유저가 assume 할 역활(Role) 생성

### 3. AWS CLI에서 Assume-Role

추가로 토큰 사용

## Switching to a role (console)

---

추가적으로 AWS Console 에서 역할 전환 = `Switching to a role (console)` 또한 내부적으로 `Assume-Role`을 수행합니다.

![Switching to a role (console)](/assets//img/content/AWS/001/004.png){:.img-s}

`> 역할 전환`{:.img-caption}

## 끝으로

---

AWS 자격 증명과 Access key 그리고 Assume-Role 에 대해서 정리를 해보자면 아래와 같습니다.

- AWS에서는 여러가지 방식의 자격 증명 방식 존재
- 그 중에서 개발 관련된 자격 증명 방식은 크게 두가지가 존재
    1. Access key : 장기 자격 증명 방식
    2. Assume-Role : 임시 자격 증명 방식
- Access key 방식은 사용자 권한을 그대로 이용 할 수 있고, 만료기간이 없기 때문에 유출시 치명적
- Assume-Role 방식이 만료 기간이 있는 토큰을 이용하기 때문에 보안이 뛰어남
