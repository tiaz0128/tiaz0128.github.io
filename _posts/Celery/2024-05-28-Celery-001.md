---
layout: post
date: 2024-05-28
catalogue: "Celery"
subject: "Celery"
title: "Celery 기본 사용법"
excerpt: "Celery를 사용해 RabbitMQ에 publish / consume"
author: tiaz
permalink: /Celery/1
tags: [Celery, RabbitMQ]
---

## 응답이 너무 느려

---

요청(_Request_)을 처리하는데 오래 걸리는 작업있다면, 화면에서는 응답(_Response_)가 올때까지 기다려야 하는 문제가 있습니다.

![Celery](/assets/img/content/Celery/001/001.png)

`>응답이 오질 않아... 새로고침 해? 말어?`{:.img-caption}

그래서 일단 요청에 대한 응답을 먼저 보내고 실제 요청에 대한 작업은 뒤에서 처리 되는 식으로 문제를 해결합니다.
이런 방식을 *'작업 큐(Task Queue)'*{:.yellow}라고 합니다.

작업 큐는 시간이 오래 걸리거나 리소스를 많이 사용하는 작업을 메인 애플리케이션 흐름에서 분리하여 백그라운드에서 처리할 수 있게 해주는 시스템입니다.

## Celery

---

![Celery](/assets/img/title/Celery/Celery.png){:.img-200x200}

파이썬에서는 작업 큐를 사용하기 위해 `Celery`를 많이 사용됩니다. 주로 웹 애플리케이션에서 백그라운드 작업을 처리하는 데 사용되며, 분산 시스템을 구축하는 데 매우 유용합니다.

Celery는 크게 세 가지 주요 컴포넌트로 구성되어 있습니다.

- 클라이언트 (Client)
- 브로커 (Broker)
- 워커 (Worker)

## Celery 구성

---

### 클라이언트 (Client)

작업을 생성하고 브로커에 전송하는 역할을 합니다. 일반적으로 웹 애플리케이션이나 스크립트가 클라이언트가 됩니다. Celery의 API를 사용하여 작업을 정의하고 실행을 요청합니다.

### 브로커 (Broker)

클라이언트와 워커 사이에서 메시지를 중개합니다. 작업 메시지를 저장하고 워커에게 전달하는 역할을 합니다.
주로 사용되는 브로커

- RabbitMQ: 가장 안정적이고 추천되는 옵션
- Redis: 간단한 설정과 빠른 성능
- Amazon SQS: AWS 환경에서 사용

### 워커 (Worker)

브로커로부터 작업을 받아 실제로 실행하는 프로세스입니다. 여러 워커를 동시에 실행하여 작업을 병렬 처리할 수 있습니다. 작업 결과를 결과 백엔드에 저장할 수 있습니다.

### 결과 백엔드 (Result Backend) - 선택적 컴포넌트

작업의 상태와 결과를 저장합니다. 클라이언트가 작업 상태를 조회하거나 결과를 가져올 때 사용합니다. Redis, 데이터베이스 등을 백엔드로 사용할 수 있습니다.

### 추가적인 구성요소

- Flower: Celery 모니터링 및 관리를 위한 웹 기반 도구
- Beat: 주기적인 작업 스케줄링을 위한 스케줄러

## Celery 작동 과정

---

1. 클라이언트가 작업을 생성하고 브로커에 전송합니다.
2. 브로커는 받은 작업을 큐에 저장합니다.
3. 워커는 브로커의 큐를 모니터링하고 있다가 새 작업이 들어오면 가져갑니다.
4. 워커가 작업을 실행합니다.
5. 작업 결과는 결과 백엔드에 저장됩니다 (설정된 경우).
6. 클라이언트는 필요에 따라 결과 백엔드에서 작업 상태나 결과를 조회할 수 있습니다.

## Celery 실전

---

### 설치

```bash
$ pip install Celery
```

## RabbitMQ

---

```bash
$ docker run -d -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.13-management
```

## Celery Worker

---

```bash
$ celery -A run worker -Q test-queue,beat-queue --hostname worker@%h -c 4
```

## Celery Beat

---

```bash
$ celery -A run beat
```

## 정리

---

### 기본 구조

- Producer: 작업을 생성하고 큐에 전송합니다.
- Broker: 작업을 저장하고 워커에게 전달합니다.
- Worker: 실제 작업을 수행합니다.
- Result Backend: 작업 결과를 저장합니다.

### 주요 특징

- 비동기 작업 처리: 시간이 오래 걸리는 작업을 백그라운드에서 비동기적으로 처리
- 분산 아키텍처: 여러 워커(worker)를 사용하여 작업을 분산 처리
- 유연한 메시지 브로커 지원: RabbitMQ, Redis 등 다양한 메시지 브로커를 사용
- 스케줄링: 주기적인 작업을 예약하고 실행 가능
- 모니터링 및 관리: Flower와 같은 도구를 통해 작업 상태를 모니터링하고 관리
