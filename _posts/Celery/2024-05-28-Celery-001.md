---
layout: post
ins_date: 2024-05-28
upd_date: 2025-02-12
category: "Celery"
subject: "Celery"
title: "Celery ê¸°ë³¸ ì‚¬ìš©ë²•"
description: "Celeryì™€ RabbitMQë¥¼ í™œìš©í•œ ë¶„ì‚° ì‘ì—… ì²˜ë¦¬"
author: tiaz0128
permalink: /Celery/1
next_post: /Celery/2
tags: [Celery, RabbitMQ]
---

{% include template/github.html
  repo_name="tiaz0128/celery-tutorial"
  url="https://github.com/tiaz0128/celery-tutorial/tree/basic"
  branch="basic"
%}

## ì‘ë‹µì´ ë„ˆë¬´ ëŠë ¤

ìš”ì²­(_Request_)ì„ ì²˜ë¦¬í•˜ëŠ”ë° ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…ìˆë‹¤ë©´, í™”ë©´ì—ì„œëŠ” ì‘ë‹µ(_Response_)ê°€ ì˜¬ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.

![Wait Response](/assets/img/content/Celery/001/001.webp)

`>ì‘ë‹µì´ ì˜¤ì§ˆ ì•Šì•„... ìƒˆë¡œê³ ì¹¨ í•´? ë§ì–´?`{:.img-caption}

ê·¸ë˜ì„œ ì¼ë‹¨ ìš”ì²­ì„ ì‘ì—…ì€ íì— ë„£ê³ , ì‘ë‹µì„ ë¨¼ì € ë³´ë‚´ê³  ì‹¤ì œ ìš”ì²­ì— ëŒ€í•œ ì²˜ë¦¬ëŠ” ë’¤ì—ì„œ ìˆ˜í–‰í•´ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤. ì´ëŸ° ë°©ì‹ì„ *'ì‘ì—… í(Task Queue)'*{:.yellow}**ë¥¼ ì´ìš©í•œ ë¶„ì‚° ì²˜ë¦¬ ë¼ê³  í•©ë‹ˆë‹¤.**{:.yellow}

ì‘ì—… íëŠ” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ê±°ë‚˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë§ì´ ì‚¬ìš©í•˜ëŠ” ì‘ì—…ì„ ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ íë¦„ì—ì„œ ë¶„ë¦¬í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## Celery

![Celery logo](/assets/img/title/Celery/Celery.webp){:.img-200x200}

íŒŒì´ì¬ì—ì„œëŠ” ì‘ì—… íë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `Celery`ë¥¼ ë§ì´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì£¼ë¡œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ë¶„ì‚° ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ëŠ” ë° ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

CeleryëŠ” í¬ê²Œ ì„¸ ê°€ì§€ ì£¼ìš” ì»´í¬ë„ŒíŠ¸ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

- í´ë¼ì´ì–¸íŠ¸(Client)
- ë¸Œë¡œì»¤(Broker)
- ì›Œì»¤(Worker)

## Celery êµ¬ì„±

### í´ë¼ì´ì–¸íŠ¸(Client)

ì‘ì—…ì„ ìƒì„±í•˜ê³  ë¸Œë¡œì»¤ì— ì „ì†¡í•˜ëŠ” ì—­í• ì„ í•˜ë©°, `Producer`ë¼ê³ ë„ í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ í´ë¼ì´ì–¸íŠ¸ê°€ ë©ë‹ˆë‹¤. Celeryë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì—…ì„ ì •ì˜í•˜ê³  ì‹¤í–‰ì„ ìš”ì²­í•©ë‹ˆë‹¤.

### ë¸Œë¡œì»¤(Broker)

í´ë¼ì´ì–¸íŠ¸ì™€ ì›Œì»¤ ì‚¬ì´ì—ì„œ ë©”ì‹œì§€ë¥¼ ì¤‘ê°œ í•˜ë©° `Task Queue / Message Queue`ë¼ê³ ë„ í•©ë‹ˆë‹¤. ì‘ì—… ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ê³  ì›Œì»¤ì—ê²Œ ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

### ì›Œì»¤(Worker)

ë¸Œë¡œì»¤ë¡œë¶€í„° ì‘ì—…ì„ ë°›ì•„ ì‹¤ì œë¡œ ì‹¤í–‰í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ì´ë©°, `Consumer`ë¼ê³ ë„ í•©ë‹ˆë‹¤. ì—¬ëŸ¬ ì›Œì»¤ë¥¼ ë™ì‹œì— ì‹¤í–‰í•˜ì—¬ ì‘ì—…ì„ ë³‘ë ¬ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‘ì—… ê²°ê³¼ë¥¼ ê²°ê³¼ ë°±ì—”ë“œì— ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% include template/youtube.html
    url="https://www.youtube.com/embed/0lyrd5FlETQ?si=pgezWMadC3_G_1_9"
%}

`> ì–„íŒí•œ ì½”ë”©ì‚¬ì „ : Message Broker - ì¹´í”„ì¹´ì™€ RabbitMQë¥¼ ì•Œì•„ë³´ì`{:.img-caption}

## ì¶”ê°€ êµ¬ì„±ìš”ì†Œ

ì„ íƒì ìœ¼ë¡œ êµ¬ì„± í•  ìˆ˜ ìˆëŠ” ì»´í¬ë„ŒíŠ¸ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

### ê²°ê³¼ ë°±ì—”ë“œ(Result Backend)

ì‘ì—…ì˜ ìƒíƒœì™€ ê²°ê³¼ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ì—… ìƒíƒœë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. Redis, ë°ì´í„°ë² ì´ìŠ¤ ë“±ì„ ë°±ì—”ë“œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê·¸ ì´ì™¸ì—

- `Beat`: ì£¼ê¸°ì ì¸ ì‘ì—… ìŠ¤ì¼€ì¤„ë§ì„ ìœ„í•œ ìŠ¤ì¼€ì¤„ëŸ¬
- `Flower`: Celery ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬ë¥¼ ìœ„í•œ ì›¹ ê¸°ë°˜ ë„êµ¬

## Celery ì‘ë™ ê³¼ì •

![Celery working flow](/assets/img/content/Celery/001/002.webp)

1. í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ì—…ì„ ìƒì„±í•˜ê³  ë¸Œë¡œì»¤ì— ì „ì†¡
2. ë¸Œë¡œì»¤ëŠ” ë°›ì€ ì‘ì—…ì„ íì— ì €ì¥
3. ì›Œì»¤ëŠ” ë¸Œë¡œì»¤ì˜ íë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³  ìˆë‹¤ê°€ ìƒˆ ì‘ì—…ì´ ë“¤ì–´ì˜¤ë©´ ê°€ì ¸ê°
4. ì›Œì»¤ê°€ ì‘ì—…ì„ ì‹¤í–‰
5. ì‘ì—… ê²°ê³¼ëŠ” ê²°ê³¼ ë°±ì—”ë“œì— ì €ì¥ (ì„¤ì •ëœ ê²½ìš°)
6. í´ë¼ì´ì–¸íŠ¸ëŠ” í•„ìš”ì— ë”°ë¼ ê²°ê³¼ ë°±ì—”ë“œì—ì„œ ì‘ì—… ìƒíƒœë‚˜ ê²°ê³¼ë¥¼ ì¡°íšŒ

## Celery í™˜ê²½ êµ¬ì¶•

ê°€ì¥ ê¸°ë³¸ì ì¸ REST APIë¥¼ í†µí•´ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” êµ¬ì„±ì„ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.

- Client : FastAPI
- Broker : RabbitMQ
- Result Backend : Redis

ë„ì»¤ë¥¼ ì´ìš©í•´ì„œ ê° ì»¨í„°ì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê² ìŠµë‹ˆë‹¤.

### RabbitMQ

[Installing RabbitMQ](https://www.rabbitmq.com/docs/download){:target="_blank"} í˜ì´ì§€ë¥¼ ì°¸ê³ í•©ë‹ˆë‹¤.

```bash
$ docker run -d -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:4.0-management
```

### Redis

[Run Redis Stack on Docker](https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/docker/){:target="_blank"} í˜ì´ì§€ë¥¼ ì°¸ê³ í•©ë‹ˆë‹¤. ì—¬ê¸°ì—ì„œëŠ” `redis:alpine` ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```bash
$ docker run -d --rm --name redis -p 6379:6379 redis:alpine
```

## fastapi ì‘ì„±

### ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

ìš°ì„  í•„ìš”í•œ íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```bash
$ pip install Celery fastapi

$ pip install "uvicorn[standard]"
```

### í´ë” êµ¬ì¡°

apps/rest-api í´ë”ë‚´ì— fastapi ì½”ë“œë¥¼ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```text
project/
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ rest-api/
â”‚       â””â”€â”€ run.py    (ì¶”ê°€ íŒŒì¼)
```

### run.py

fastapi ë¼ìš°í„°ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. `Celery` ë¼ì´ë¸ŒëŸ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ brokerë¥¼ ì§€ì •í•´ì„œ ì•±ì„ ìƒì„±í•©ë‹ˆë‹¤. ìƒì„±í•œ ì•±ì˜ `send_task` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ brokerì— ì‘ì—…ì„ ì „ì†¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<div class="file-name">/apps/rest-api/run.py</div>

```python
from random import randint
from fastapi import FastAPI
from fastapi.responses import PlainTextResponse

from celery import Celery

app = FastAPI()

url = "localhost"
username = "guest"
password = "guest"

celery = Celery(
    "Client Publisher App",
    broker=f"pyamqp://{username}:{password}@{url}//",
    backend=f"redis://{url}:6379/0",
)

@app.get("/publish")
def publish_task():
    a = randint(1, 100)
    b = randint(1, 100)

    celery.send_task(
        "tasks.sum.consume_task",
        kwargs={"a": a, "b": b},
        queue="sum-queue",
    )

    return PlainTextResponse(f"FastAPI : {a=},{ b=} Published to the queue")
```

### send_task ì„¤ëª…

`send_task`ëŠ” Celeryì—ì„œ ì‘ì—…(Task)ì„ ì§ì ‘ importí•˜ì§€ ì•Šê³  ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤. ì¦‰, Celery ì¸ìŠ¤í„´ìŠ¤ë¥¼ í†µí•´ ì‘ì—… ì´ë¦„ì„ ë¬¸ìì—´ë¡œ ì „ë‹¬í•˜ì—¬ ì‹¤í–‰í•˜ë¯€ë¡œ, ì½”ë“œ ê°„ ì˜ì¡´ì„±ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì²«ë²ˆì§¸ ì¸ìê°’(=name)ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ì‘ì—…ì„ ì²˜ë¦¬í•  `worker`(=ì²˜ë¦¬ í•¨ìˆ˜)ë¥¼ ì§€ì •
- kwargs ì¸ìê°’ìœ¼ë¡œ worker ì¸ìê°’ì„ ì „ë‹¬ ê°€ëŠ¥
- queue ì¸ìê°’ìœ¼ë¡œ ì‘ì—…ì„ ê°€ì ¸ì˜¬ broker íë¥¼ ì§€ì •

```python
celery.send_task(
    "tasks.sum.consume_task",
    kwargs={"a": a, "b": b},
    queue="sum-queue",
)
```

```bash
$ cd apps/rest-api

$ uvicorn run:app
```

## ì‘ì—… ìƒì„±í•´ë³´ê¸°

fastapië¥¼ í†µí•´ì„œ RabbitMQë¡œ ì‘ì—…ì„ ë„£ì–´ë³´ê³  í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

### fastapi ë¡œ ì‘ì—… ìƒì„±

fastapië¥¼ í†µí•´ì„œ ì‘ì—…ì„ ìƒì„±(publish) í•´ë³´ê² ìŠµë‹ˆë‹¤. ì•„ë˜ì˜ URLë¡œ ì ‘ì†í•˜ë©´ ëœë¤í•œ ë‘ ìˆ˜ë¥¼ ì¸ìë¡œ í•œ ì‘ì—…ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ë²ˆ ì‹œë„í•˜ê³  ì‘ì—…ì´ ë¸Œë¡œì»¤(=RabbitMQ)ì— ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```text
localhost:8000/publish
```

### RabbitMQ ì›¹ ì½˜ì†”

RabbitMQëŠ” ê¸°ë³¸ì ì¸ ì›¹ ì½˜ì†”ì„ ì œê³µí•´ì¤ë‹ˆë‹¤. ì•„ë˜ì˜ URLë¡œ ì ‘ì†í•´ ë´…ì‹œë‹¤.

```text
localhost:15672
```

ì½˜ì†” ë¡œê·¸ì¸ ì •ë³´ëŠ” ê¸°ë³¸ ì„¸íŒ…ë˜ëŠ” ì•„ì´ë”” / íŒ¨ìŠ¤ì›Œë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ í ì •ë³´ë¥¼ í™•ì¸í•´ ë´…ì‹œë‹¤.

- Username : guest
- Password : guest

ì‘ì—…ì„ ìƒì„±í•œ í `sum-queue`ê°€ ìƒì„±ë˜ì–´ ìˆê³  ëª‡ê°œì˜ ì‘ì—…(=ì—¬ê¸°ì„œëŠ” Message)ê°€ ìŒ“ì—¬ ìˆëŠ”ì§€ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŒ€ìƒ íë¥¼ í´ë¦­í•´ì„œ `Get messages`ë¥¼ í†µí•´ì„œ í˜„ì¬ ìŒ“ì—¬ìˆëŠ” ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì™€ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Celery working flow](/assets/img/content/Celery/001/003.webp)

`RabbitMQ ì›¹ ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥`{:.img-caption}

## Celery Worker

### í´ë” êµ¬ì¡°

ì´ì œ ì‘ì—…ì„ ë¸Œë¡œì»¤ íì— ë„£ì—ˆìœ¼ë‹ˆ í•´ë‹¹ ì‘ì—…ì„ ê°€ì ¸ì™€ ì²˜ë¦¬í•˜ëŠ” **Celery ì›Œì»¤(Worker)**ë¥¼ ì‹¤í–‰í•  í™˜ê²½ì„ êµ¬ì„±í•˜ê² ìŠµë‹ˆë‹¤. `apps/worker/` í´ë”ë¥¼ ìƒì„±í•˜ê³  í•„ìš”í•œ íŒŒì¼ì„ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤.

```text
project/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ rest-api/
â”‚   â””â”€â”€ worker/ 
â”‚       â”œâ”€â”€ celeryconfig.py (ì¶”ê°€ íŒŒì¼)
â”‚       â””â”€â”€ run.py          (ì¶”ê°€ íŒŒì¼)
```

### run.py

Celery ì•±ì„ ìƒì„±í•˜ê³  `config_from_object`ë¥¼ í†µí•´ì„œ `celeryconfig` íŒŒì¼ì—ì„œ ì„¤ì •ì„ ì½ì–´ì™€ì„œ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤. Celeryì˜ `include` ì˜µì…˜ì€ ì‘ì—… ëª¨ë“ˆì„ ëª…ì‹œì ìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

<div class="file-name">/apps/worker/run.py</div>

```python
from celery import Celery

app = Celery(
    "Celery Worker",
    include=[
        "tasks.sum",
    ],
)

app.config_from_object("celeryconfig")
```

### celeryconfig.py

ì„¤ì •ì„ ì‘ì„±í•˜ëŠ” íŒŒì¼ì…ë‹ˆë‹¤. ê° ë³€ìˆ˜ì— ê°’ì„ í• ë‹¹í•©ë‹ˆë‹¤. [Configuration and defaults](https://docs.celeryq.dev/en/stable/userguide/configuration.html#configuration){:target="_blank"} í˜ì´ì§€ë¥¼ ì°¸ê³ í•©ë‹ˆë‹¤.

<div class="file-name">/apps/worker/celeryconfig.py</div>

```python
broker_url = "pyamqp://guest:guest@localhost//"
result_backend = "redis://localhost:6379/0"

task_serializer = "json"
accept_content = ["json"]
result_serializer = "json"
enable_utc = True
timezone = "UTC"
broker_connection_retry_on_startup = True
```

- broker_url: ë©”ì‹œì§€ ë¸Œë¡œì»¤ì˜ URLì„ ì§€ì •
- result_backend: ì‘ì—… ê²°ê³¼ë¥¼ ì €ì¥í•  ë°±ì—”ë“œì˜ URLì„ ì§€ì •
- task_serializer: ì‘ì—…ì„ ì§ë ¬í™”í•  ë•Œ ì‚¬ìš©í•  í˜•ì‹ì„ ì§€ì •
- accept_content: í—ˆìš©í•  ë©”ì‹œì§€ í˜•ì‹ì˜ ë¦¬ìŠ¤íŠ¸. ì—¬ê¸°ì„œëŠ” JSON í˜•ì‹ë§Œ í—ˆìš©
- result_serializer: ê²°ê³¼ë¥¼ ì§ë ¬í™”í•  ë•Œ ì‚¬ìš©í•  í˜•ì‹ì„ ì§€ì •
- enable_utc: UTC ì‹œê°„ëŒ€ ì‚¬ìš©ì„ í™œì„±í™”
- timezone: Celeryê°€ ì‚¬ìš©í•  ê¸°ë³¸ ì‹œê°„ëŒ€ë¥¼ ì„¤ì •
- broker_connection_retry_on_startup: ì‹œì‘ ì‹œ ë¸Œë¡œì»¤ ì—°ê²° ì¬ì‹œë„ë¥¼ í™œì„±í™”

### Task íŒŒì¼ ì¶”ê°€

tasks í´ë”ë¥¼ ë§Œë“¤ê³  ì‹¤ì œë¡œ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ì‘ì—… ëª¨ë“ˆ `sum.py`ë¥¼ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```text
project/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ rest-api/
â”‚   â””â”€â”€ worker/
â”‚       â”œâ”€â”€ tasks/
â”‚       â”‚   â””â”€â”€ sum.py (ì¶”ê°€ íŒŒì¼)
â”‚       â”œâ”€â”€ celeryconfig.py
â”‚       â””â”€â”€ run.py
```

### tasks/sum.py

Celeryì—ì„œëŠ” ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•  ì‘ì—…ì„ ì •ì˜í•˜ê¸° ìœ„í•´ `@app.task` ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ ì •ì˜ëœ ì‘ì—…ì€ Celery ì›Œì»¤ê°€ íì—ì„œ ê°€ì ¸ì™€ì„œ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤. ì•„ë˜ ì˜ˆì œì—ì„œëŠ” ì‘ì—… ìˆ˜í–‰ì— ì¼ì • ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ìƒí™©ì„ ê°€ì •í–ˆìŠµë‹ˆë‹¤.

<div class="file-name">tasks/sum.py</div>

```python
import logging
import time

from run import app

@app.task(queue="sum-queue")
def consume_task(a, b):
    time.sleep(5)

    logging.info(f"{a=}, {b=}")
    logging.info(f"Task Done : {a} + {b} = {a + b}")

    return a + b
```

### Worker ì‹¤í–‰

Workerê°€ ì‹¤í–‰ë˜ë©´ RabbitMQì— `sum-queue`ì— ë¯¸ë¦¬ ë“¤ì–´ê°€ ìˆë˜ ì‘ì—…ì„ ê°€ì ¸ì™€ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì²˜ë¦¬ ê²°ê³¼ëŠ” Redisì— ì €ì¥ë©ë‹ˆë‹¤. ë§ì€ ìš”ì²­ì´ ë“¤ì–´ì™€ë„ ì›Œì»¤ 4ê°œê°€ ìˆœì°¨ì ìœ¼ë¡œ ì´ë¥¼ ì²˜ë¦¬ í•˜ëŠ”ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

- `-A run` : Celery ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì§€ì •. `--app` ë™ì¼
- `worker` : celery Workerë¡œ ì‹œì‘. beatë¼ëŠ” ê°’ë„ ì¡´ì¬
- `-Q sum-queue` : Workerê°€ ì†Œë¹„í•  íë¥¼ ì§€ì •. `,`ë¡œ ì—¬ëŸ¬ê°œ ì§€ì • ê°€ëŠ¥. `--queues` ë™ì¼
- `--hostname worker@%h` : ì²˜ë¦¬í•˜ëŠ” Worker ì´ë¦„. `Worker@Celery Worker`
- `-c 4` : ì›Œì»¤ê°€ ìµœëŒ€ 4ê°œì˜ ì‘ì—…ì„ ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸. `--concurrency` ë™ì¼
- `--loglevel=info` : info ë¡œê·¸ ì¶œë ¥

```bash
$ cd apps/worker

$ celery -A run worker -Q sum-queue --hostname worker@%h -c 4 --loglevel=info
```

```text
[2025-02-12 13:44:28,904: INFO/MainProcess] Task tasks.sum.consume_task[49c19f92-0c1e-4223-9827-20061856cc01] received
[2025-02-12 13:44:33,906: INFO/ForkPoolWorker-2] a=86, b=63
[2025-02-12 13:44:33,906: INFO/ForkPoolWorker-2] Task Done : 86 + 63 = 149
[2025-02-12 13:44:33,911: INFO/ForkPoolWorker-2] Task tasks.sum.consume_task[49c19f92-0c1e-4223-9827-20061856cc01] succeeded in 5.005200453000725s: 149
```

## Redis ê²°ê³¼ í™•ì¸

ì»¨ë„¤ì´í„° ë‚´ë¶€ì— ë“¤ì–´ê°€ì„œ redis-cli ëª…ë ¹ì–´ë¡œ ì½˜ì†”ë¡œ ì ‘ì†í•©ë‹ˆë‹¤. 0ë²ˆ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ê²°ê³¼ë¥¼ í™•ì¸í•´ ë´…ë‹ˆë‹¤.

```bash
$ docker exec -it redis-stack-server bash

$ redis-cli
```

```bash
127.0.0.1:6379> SELECT 0

127.0.0.1:6379> KEYS *
1) "celery-task-meta-49c19f92-0c1e-4223-9827-20061856cc01"
2) "celery-task-meta-278e1511-17d6-4802-a362-ff7fd279835c"
3) "celery-task-meta-e8ef71db-83ce-417e-ae57-c58e6e6659dc"

127.0.0.1:6379> get "celery-task-meta-49c19f92-0c1e-4223-9827-20061856cc01"
"{\"status\": \"SUCCESS\", \"result\": 149, \"traceback\": null, \"children\": [], \"date_done\": \"2025-02-12T04:44:33.906617+00:00\", \"task_id\": \"49c19f92-0c1e-4223-9827-20061856cc01\"}"
```

## ë¶€í•˜ í…ŒìŠ¤íŠ¸

`curl` ëª…ë ¹ì–´ë¥¼ í†µí•´ ë™ì‹œì— 100ê°œì˜ ì‘ì—…ì„ ìƒì„±í•˜ê³  íì— ìŒ“ì¸ ì‘ì—…ì´ ì˜ ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”!

```bash
$ for i in {1..100}; do curl -s -o /dev/null http://localhost:8000/publish & done
```

## ë§ˆë¬´ë¦¬

`Celery`ë¥¼ í†µí•´ ì‘ì—… í(Task Queue)ë¥¼ ì‚¬ìš©í•œ ë¶„ì‚°ì²˜ë¦¬ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ êµ¬ì„±ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

- Client: ì‘ì—…ì„ ìƒì„±í•˜ê³  íì— ì „ì†¡í•©ë‹ˆë‹¤.
- Broker: ì‘ì—…ì„ ì €ì¥í•˜ê³  ì›Œì»¤ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.
- Worker: ì‹¤ì œ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- Backend: ì‘ì—… ê²°ê³¼ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

Celeryë¥¼ ì‚¬ìš©í•˜ë©´ `RabbitMQ`ë‚˜ `Redis`ë¥¼ ëŒ€ì‹ í•´ ë‹¤ë¥¸ Brokerë‚˜ Backendë¡œ ì†ì‰½ê²Œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤. Celeryì™€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ë¶„ì‚°ì²˜ë¦¬ë¥¼ ì‚¬ìš©í•´ ë³´ëŠ” ê²ƒë„ ì¢‹ì„ ë“¯í•©ë‹ˆë‹¤. ğŸ˜Š

## ë‹¤ìŒìœ¼ë¡œ

{% include template/alert.html
  type="tip"
  about="ë‹¤ìŒê¸€ì—ì„œ ê³„ì† ë©ë‹ˆë‹¤."
%}

ì „ì²´ì ì¸ Celeryì˜ ì‚¬ìš©ë°©ë²•ì— ëŒ€í•´ì„œ ê³µë¶€í•´ ë³´ì•˜ìœ¼ë‹ˆ, [Celery ê¸°ì´ˆ: App & Tasks](/Celery/2){:.none target="_blank"}ì—ì„œ Celeryì˜ í•µì‹¬ êµ¬ì„±ìš”ì†Œì¸ Applicationê³¼ Tasksì˜ ê°œë…, êµ¬í˜„ ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤!
