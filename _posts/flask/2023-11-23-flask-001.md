---
layout: post
date: 2023-11-23
catalogue: "flask"
subject: "flask"
title: "Server-Sent Events (SSE) ì•ŒëŒ"
subtitle: "SSE ë¥¼ ì•Œì•„ë³´ê³ , Flask ì—ì„œ êµ¬í˜„í•´ ë´…ì‹œë‹¤."
author: tiaz0128
permalink: /flask/1
tags: [flask, sse]
---

## í”„ë¡¤ë¡œê·¸

---

Flask ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•ŒëŒ ë©”ì„¸ì§€ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì „ë‹¬í•˜ê¸° ìœ„í•´ì„œ, **Server-Sent Events (SSE)** ë¥¼ í†µí•œ ì•ŒëŒ ë©”ì„¸ì§€ë¥¼ êµ¬í˜„ í•˜ê³ ì í–ˆì„ ë•Œ ê³µë¶€í–ˆë˜ ë‚´ìš©ê³¼ êµ¬í˜„ ì‹œ ê²ªì—ˆë˜ ì‹œí–‰ì°©ì˜¤ì™€ ê²½í—˜ì„ ì ì–´ë´…ë‹ˆë‹¤.

## ì†Œì¼“ vs SSE

---

ì†Œì¼“ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  SSE ë¥¼ ì„ íƒ ì´ìœ ëŠ” ê°„ë‹¨í•©ë‹ˆë‹¤. ì•ŒëŒì€ ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì£¼ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ê³  ê·¸ì¤‘ì— ìƒˆë¡œìš´ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ íŠ¹ë³„íˆ

> ìƒˆë¡œìš´ ì•ŒëŒì´ ì™”ì–´!

ë¼ê³  ì•Œë ¤ì£¼ê¸°ë§Œ í•˜ë©´, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ë¦¬ëœë”ë§ í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ì•ŒëŒì„ ë°›ì•„ì˜¤ëŠ” API ë¥¼ í˜¸ì¶œí•˜ë©´ ë˜ê¸°ì—, í´ë¼ì´ì–¸íŠ¸ì™€ ì–‘ë°©í–¥ í†µì‹ ì´ í•„ìš”ì¹˜ ì•Šë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤. ëª‡ê°€ì§€ SSE ì˜ íŠ¹ì§•ì„ ì ì–´ ë³´ê² ìŠµë‹ˆë‹¤.

1. **í…ìŠ¤íŠ¸ ê¸°ë°˜**: ë°ì´í„°ëŠ” ìˆœìˆ˜í•œ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
2. **ë‹¨ë°©í–¥ í†µì‹ **: ë°ì´í„°ëŠ” ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œë§Œ ì „ì†¡ë©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œëŠ” ë°ì´í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
3. **ì§€ì†ì  ì—°ê²°**: í•œ ë²ˆ ì—°ê²°ì´ ìˆ˜ë¦½ë˜ë©´, ì„œë²„ëŠ” ì—°ê²°ì„ ì§€ì†ì ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. **ìë™ ì¬ì—°ê²°**: ì—°ê²°ì´ ëŠì–´ì¡Œì„ ê²½ìš° í´ë¼ì´ì–¸íŠ¸ëŠ” ìë™ìœ¼ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.

## Flask SSE êµ¬í˜„

---

ê¸°ë³¸ ì ì¸ SSE êµ¬í˜„ Response ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬, `content_type` ì„ **text/event-stream** ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. **text/event-stream** ì€ **ë¬¸ìì—´ ë°ì´í„°**ë¥¼ ë°˜í™˜í•˜ëŠ”SSE ì˜ ì½˜í…ì¸  íƒ€ì…ì…ë‹ˆë‹¤. ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œ ë³´ë‚´ëŠ” ì´ ë¬¸ìì—´ ë°ì´í„°ëŠ” **íŠ¹ì •í•œ ê·œì¹™**ì„ ë”°ë¦…ë‹ˆë‹¤. ìš°ì„ ì€ ê¸°ë³¸ì ì¸ ë°ì´í„°ë¥¼ ë³´ë‚´ëŠ” í˜•ì‹ì…ë‹ˆë‹¤. 

1. `data:` ë¼ëŠ” ë¬¸ìì—´ë¡œ ì‹œì‘
2. ë³´ë‚´ê³  ì‹¶ì€ ë¬¸ìì—´ ë°ì´í„°
3. ê° ë©”ì‹œì§€ëŠ” ë¹ˆ ì¤„(ì¦‰, `\n\n`)ìœ¼ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤. 

<div class="file-name">main.py</div>
```python
from flask import Flask, Response
import time

app = Flask(__name__)

def generate():
    while True:
        # DO NOT forget the prefix and suffix
        yield f"data: Hello! {user_id}\n\n"
        time.sleep(5)

@app.get("/connection/<user_id>")
def connection(user_id: str):
    return Response(generator(user_id), content_type="text/event-stream")

if __name__ == "__main__":
    app.run(port=5000)
```

<div class="file-name">js</div>
```js
const eventSource = new EventSource("http://localhost:5000/connection/tiaz");

eventSource.onmessage = function(event) {
    console.log("New event:", event.data);
};
```

![ê·¸ë¦¼ 1.](/assets/img/content/flask/001/1.png)

## text/event-stream í•„ë“œ

---

SSE ë©”ì‹œì§€ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì „ì†¡ë˜ë©°, ëª‡ ê°€ì§€ **íŠ¹ë³„í•œ í•„ë“œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ì„±ë©ë‹ˆë‹¤. ì£¼ìš” í•„ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

### event í•„ë“œ

ì›í•˜ëŠ” ì´ë²¤íŠ¸ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ì´ë²¤íŠ¸ ìœ í˜•ì— ëŒ€í•œ ë¦¬ìŠ¤ë„ˆ(listener)ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```text
event: notice\n
```

### data í•„ë“œ

ì´ë²¤íŠ¸ì˜ ì‹¤ì œ ë°ì´í„°ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ë°ì´í„°ëŠ” ì—¬ëŸ¬ ì¤„ì— ê±¸ì³ ìˆì„ ìˆ˜ ìˆìœ¼ë©°, ê° ì¤„ì€ **`data:`**ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ëŸ¬ ì¤„ì˜ ë°ì´í„°ëŠ” ì—°ê²°ë˜ì–´ í•˜ë‚˜ì˜ ë©”ì‹œì§€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. event ë¥¼ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ `message` ë¼ëŠ” event ê°€ ì„¤ì •ë©ë‹ˆë‹¤.

```text
data: {"userId": 1, "status": "online"}
data: {"additional": "info"}
```

### id í•„ë“œ

ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ IDë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì—°ê²°ì´ ëŠì–´ì§„ í›„ ì¬ì—°ê²° ì‹œ, í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ IDë¥¼ ì‚¬ìš©í•˜ì—¬ ëŠì–´ì§„ ì´í›„ì˜ ì´ë²¤íŠ¸ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```text
id: 12345\n
```

### retry í•„ë“œ

ì—°ê²°ì´ ëŠì–´ì§„ ê²½ìš° ì¬ì—°ê²°ì„ ì‹œë„í•˜ê¸° ì „ ëŒ€ê¸°í•´ì•¼ í•˜ëŠ” ì‹œê°„(ë°€ë¦¬ì´ˆ ë‹¨ìœ„)ì„ ì§€ì •í•©ë‹ˆë‹¤.

```text
retry: 3000\n
```

ì´ëŸ¬í•œ í•„ë“œë“¤ì€ ê°ê° ê°œë³„ì ìœ¼ë¡œ ì‚¬ìš©ë  ìˆ˜ë„ ìˆê³ , ì¡°í•©í•˜ì—¬ ì‚¬ìš©ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```text
data: {"userId": 1, "status": "online"}

event: notice
data: {"userId": 2, "status": "offline"}

id: 67890
data: {"message": "Something happened"}

retry: 5000
data: {"retryMessage": "Please wait"}
```

ì´ëŸ¬í•œ í˜•ì‹ì„ ë”°ë¥´ë©´, SSEë¥¼ ì§€ì›í•˜ëŠ” ì›¹ ë¸Œë¼ìš°ì €ë‚˜ í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ëŸ¬í•œ ë©”ì‹œì§€ë¥¼ ì ì ˆíˆ íŒŒì‹±í•˜ê³ , í•„ìš”í•œ ë™ì‘ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì„œë²„ì—ì„œ ì£¼ì˜ ì‚¬í•­

---

**ë¬¸ìì—´ ë°ì´í„°**ë¥¼ ë°˜í™˜í•˜ëŠ”SSE ëŠ” ìœ„ì—ì„œ ì„¤ëª…í•œ í˜•ì‹ì„ ë”°ë¥´ë©´ ë©ë‹ˆë‹¤. ë‹¤ë§Œ, **JSON ë°ì´í„°**ë¥¼ ë³´ë‚´ê³  ì‹¶ì€ ê²½ìš°, ë³´ë‚´ê³ ì í•˜ëŠ” `data` í•„ë“œì— ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ì§ë ¬í™”(**Serialization)** ë¥¼ ìˆ˜í–‰í•´ì„œ í˜•ì‹ì— ë§ëŠ” ë¬¸ìì—´ë¡œ êµ¬ì„±í•´ì„œ ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤.

```python
yield f"""event: notice\ndata: {json.dumps(data)}\n\n"""
```

<div class="file-name">main.py</div>
```python
from flask import Flask, Response
from time import sleep
import json

app = Flask(__name__)

def generator(user_id):
    yield f"data: Hello! {user_id}\n\n"

    while True:
        data = {"name": user_id}
        yield f"""event: notice\ndata: {json.dumps(data)}\n\n"""
        sleep(5)

@app.get("/connection/<user_id>")
def connection(user_id: str):
    return Response(generator(user_id), content_type="text/event-stream")

if __name__ == "__main__":
    app.run(port=5000)
```

<div class="file-name">js</div>
```js
const eventSource = new EventSource("http://localhost:5000/connection/tiaz");

eventSource.onmessage = function(event) {
    console.log("New event:", event.data);
};

eventSource.addEventListener("notice", (e) => {
  console.log(event.data);
});
```

![ê·¸ë¦¼ 2.](/assets/img/content/flask/001/2.png)

## Server-Sent Events ì •ë¦¬

---

**Server-Sent Events(SSE)** ëŠ” ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ **ë¬¸ìì—´ ë°ì´í„°**ë¥¼ ì „ì†¡ í•  ìˆ˜ ìˆëŠ” **ë‹¨ë°©í–¥ í†µì‹ ** ë°©ë²•ì…ë‹ˆë‹¤. êµ¬í˜„ ì‹œ ì¤‘ìš”í•œ ê²ƒì€ ê·œê²©ì— ì•Œë§ì€ í˜•íƒœì˜ ë¬¸ìì—´ì„ êµ¬ì„±í•˜ëŠ” ê²ƒ ì…ë‹ˆë‹¤. ê° í•„ë“œì˜ ê·œê²©ì„ ì •í™•íˆ í™•ì¸í•˜ê³  ì‘ì„± í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤. ğŸ˜Š

ì‹¤ì œ ì—…ë¬´ì—ì„œ êµ¬í˜„í•˜ë©´ì„œ ë§Œë‚¬ë˜ ë¬¸ì œëŠ” ğŸ”—ë‹¤ìŒí¸ : **[Server-Sent Events (SSE) ì•ŒëŒ : í™œìš©í¸
](/flask/2){:target="_blank"}** ì—ì„œ ì ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
