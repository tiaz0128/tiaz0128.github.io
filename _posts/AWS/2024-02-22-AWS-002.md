---
layout: post
date: 2024-02-22
catalogue: "AWS"
subject: "AWS"
title: "AWS SDK ê°œë°œ í™˜ê²½ êµ¬ì¶•"
description: "AWS ê°œë°œì„ ìœ„í•œ SDK ì‚¬ìš©ë°©ë²•"
author: tiaz0128
permalink: /AWS/2
tags: [AWS, AWS SDK]
---

`AWS CLI`, `AWS SDK`ë¥¼ ì‚¬ìš©í•´ì„œ ê°œë°œ í™˜ê²½ì„ êµ¬ì¶•í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

## AWSë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•

---

AWSë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•ì—ëŠ” í¬ê²Œ 3ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ì„œëŠ” ì‹¤ì œ ì›¹ì—ì„œ ë¡œê·¸ì¸í•˜ëŠ” `AWS console` ë°©ì‹ì„ ì œì™¸í•˜ê³  `AWS CLI`, `AWS SDK` ë¥¼ ì´ìš©í•˜ê³  ê³µë¶€í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤. ë˜í•œ ê°œë°œ í™˜ê²½ì— ë§ê²Œ ì„¸íŒ…í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

## ì„ì‹œ ìê²© ì¦ëª…(AssumeRole)

---

ê°œë°œì‹œ ì‚¬ìš©í•˜ëŠ” AWS ìê²©ì¦ëª…ì€ í¬ê²Œ ë‘ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.

- Access key
- AssumeRole

`Access key`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ” ìœ ì¶œì‹œ ì¹˜ëª…ì ì´ë¯€ë¡œ, ë°˜ë“œì‹œ `AssumeRole`ì„ ì´ìš©í•´ì„œ í† í°ì„ ë°œê¸‰ë°›ì•„ ì‚¬ìš©í•©ì‹œë‹¤. Assumeì˜ ëŒ€ìƒì¸ ì—­í• (Role) ë˜í•œ í•„ìš”í•œ ìµœì†Œ ê¶Œí•œë§Œ ì„¤ì •í•˜ëŠ”ê²Œ ë°”ëŒì§í•©ë‹ˆë‹¤.

## AWS CLI : AssumeRole

AWS CLIì—ì„œ ì•„ë˜ì˜ ëª…ë ¹ì„ í†µí•´ JSON í˜•íƒœì˜ í† í°ì„ ë°œê¸‰ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í† í°ì„ ë°›ì•„ì„œ ë‹¤ì‹œ ê·¸ í† í°ì„ í™˜ê²½ë³€ìˆ˜ì— ë“±ë¡í•˜ê¸°ëŠ” ë¬´ì²™ì´ë‚˜ ë²ˆê±°ë¡­ìŠµë‹ˆë‹¤. ê²Œë‹¤ê°€ í† í°ì˜ ìµœëŒ€ ë§Œë£Œì‹œê°„ì€ 12ì‹œê°„ì´ê¸° ë•Œë¬¸ì— í•„ìš”í• ë•Œë§ˆë‹¤ ë§¤ë²ˆ í•´ë‹¹ ì‘ì—…ì„ ë°˜ë³µí•´ì•¼ í•©ë‹ˆë‹¤.

```bash
$ aws sts assume-role --role-arn <ROLE_ARN> --role-session-name <session-name>
```

```text
{
    "Credentials": {
        "AccessKeyId": "ASIA.......",
        "SecretAccessKey": "YwyGY8dF5.......",
        "SessionToken": "IQoJb3JpZ2.......",
        "Expiration": "2024-04-21T08:08:12Z"
    },
}
```

## AssumeRole ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

---

AssumeRoleì—ì„œ í•„ìš”í•œ 3ê°€ì§€ ê°’ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ì´ ê°’ë“¤ì„ ìë™ìœ¼ë¡œ í™˜ê²½ë³€ìˆ˜ì— ë“±ë¡í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ë´…ì‹œë‹¤.

- `Credentials.AccessKeyId`
- `Credentials.SecretAccessKey`
- `Credentials.SessionToken`

JSON ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” `jq` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. `$()`ëŠ” ì‰˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ëª…ë ¹ì–´ ì¹˜í™˜(Command Substitution)ì„ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” êµ¬ë¬¸ì…ë‹ˆë‹¤. ì´ êµ¬ë¬¸ì€ ê´„í˜¸ ì•ˆì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.

`$ROLE_ARN` í™˜ê²½ë³€ìˆ˜ëŠ” í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ ë ë•Œ ì›í•˜ëŠ” ì—­í• (Role)ì„ ì…ë ¥ ë°›ì„ ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ë‘¡ë‹ˆë‹¤.

`jq -r` ì˜µì…˜ì€ ì¶œë ¥ì„ raw ë¬¸ìì—´ë¡œ ë°˜í™˜í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ jqëŠ” JSON ë¬¸ìì—´ í˜•íƒœë¡œ ë”°ì˜´í‘œë¡œ ë‘˜ëŸ¬ì‹¸ì—¬ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ `-r` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´, ë”°ì˜´í‘œ ì—†ì´ raw ë¬¸ìì—´ì„ ì¶œë ¥í•©ë‹ˆë‹¤. ë”°ì˜´í‘œ ì—†ëŠ” raw í˜•íƒœì˜ í† í°ì„ `export` ë¥¼ ìˆ˜í–‰í•´ì„œ AWS CLIì—ì„œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ë³€ìˆ˜ëª…ìœ¼ë¡œ ë“±ë¡ í•©ë‹ˆë‹¤.

```bash
$ apt install jq
```

```text
#!/bin/bash

output=$(aws sts assume-role --role-arn $ROLE_ARN --role-session-name cli-assume-session)

export AWS_ACCESS_KEY_ID=$(echo $output | jq -r '.Credentials.AccessKeyId')
export AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r '.Credentials.SecretAccessKey')
export AWS_SESSION_TOKEN=$(echo $output | jq -r '.Credentials.SessionToken')
```

ì‹¤í–‰í• ë•ŒëŠ” `ROLE_ARN` í™˜ê²½ë³€ìˆ˜ì— ì›í•˜ëŠ” ì—­í•  ARN ê°’ì„ ì…ë ¥í•©ë‹ˆë‹¤. `source` ëª…ë ¹ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‰˜ì—ë§Œ  AssumeRoleì´ ìˆ˜í–‰ë˜ê³  í™˜ê²½ë³€ìˆ˜ê°’ì´ ìë™ìœ¼ë¡œ ì„¸íŒ…ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‰˜ì„ ì¢…ë£Œí•˜ê±°ë‚˜ ìƒˆë¡œìš´ ì‰˜ì—ëŠ” AssumeRoleì´ ì ìš©ë˜ì§€ ì•Šì€ ìƒíƒœì¸ ê²ƒì„ ê¸°ì–µí•˜ê³  í•„ìš”í•œ ê²½ìš°ì—ëŠ” í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë¡œ AssumeRoleì„ ì ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

```bash
$ export ROLE_ARN=arn:aws:iam::99842...:role/dev-assume-role-AmazonS3FullAccess

$ source ./scripts/set_assume_role.sh
```

```bash
$ echo AWS_SESSION_TOKEN

$ aws sts get-caller-identity
```

## AWA CLI ë””ë²„ê¹…

---

ê¸°ë³¸ì ìœ¼ë¡œ AWS CLIëŠ” ëª…ë ¹ ì¶œë ¥ì˜ ëª…ë ¹ ê²°ê³¼ì™€ ê´€ë ¨ëœ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤. `--debug` ì˜µì…˜ì€ ë””ë²„ê·¸ ë¡œê¹…ì„ í™œì„±í™”í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ëª…ë ¹ì„ í†µí•´ í•´ë‹¹ ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- stderr ì§„ë‹¨ ì •ë³´ë§Œ ë³´ë‚´ë ¤ë©´ `2> íŒŒì¼ëª…`
- ì¶œë ¥ê³¼ stderr ì§„ë‹¨ ì •ë³´ë‘˜ ë‹¤ ë³´ë‚´ë ¤ë©´ `&> íŒŒì¼ëª…`

```bash
aws s3 ls --debug 2> debug.txt

aws s3 ls --debug &> debug.txt
```

## AWS SDK : AssumeRole

---

### 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜

AWS SDKë¥¼ ì´ìš©í•´ì„œ AWS CLIì™€ ë™ì¼í•˜ê²Œ AssumeRoleì„ í†µí•´ì„œ í† í°ì„ ë°œê¸‰ë°›ëŠ” ê°œë°œí™˜ê²½ì„ êµ¬ì¶•í•´ë³´ê² ìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ ì‚¬ìš©ë˜ëŠ” SDKëŠ” python íŒ¨í‚¤ì§€ì¸ `boto3`ì…ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ì—ëŠ” `pytest`ì™€ `python-dotenv`ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ìš°ì„  ì„¤ì¹˜í•©ë‹ˆë‹¤.

```bash
$ pip install boto3

$ pip install pytest python-dotenv
```

### 2. .env íŒŒì¼ ì‘ì„±

`.env` íŒŒì¼ì— í•„ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. AssumeRoleì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” Access key ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  Role ARN ì •ë³´ê¹Œì§€ ì…ë ¥í•©ë‹ˆë‹¤.

<div class="file-name">.env</div>

```text
AWS_ACCESS_KEY_ID=ASIA.......
AWS_SECRET_ACCESS_KEY=YwyGY8dF5.......

ROLE_ARN=arn:aws:iam::99842...:role/dev-assume-role-AmazonS3FullAccess
```

### 3. Access key ì„¸ì…˜ ìƒì„±

Access keyë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ ì„¸ì…˜ì„ `fixture`ë¡œ ì „ë‹¬í•˜ì—¬ ë‹¤ìŒ í•¨ìˆ˜ì—ì„œ AssumeRoleì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

<div class="file-name">tests/conftest.py</div>

```python
import logging
import pytest

import os
from dotenv import load_dotenv

import boto3
from boto3 import Session

# .env íŒŒì¼ ë¡œë“œ
load_dotenv()


@pytest.fixture(scope="session", name="aws_user_session")
def setup_user_session() -> Session:
    aws_access_key_id = os.getenv("AWS_ACCESS_KEY_ID")
    aws_secret_access_key = os.getenv("AWS_SECRET_ACCESS_KEY")
    region_name = os.getenv("REGION_NAME")

    return boto3.Session(
        aws_access_key_id=aws_access_key_id,
        aws_secret_access_key=aws_secret_access_key,
        region_name=region_name,
    )
```

### 4. AssumeRoleì„ í†µí•œ í† í°ìƒì„± ë° ì„¸ì…˜ ìƒì„±

ì„¸ì…˜ì„ í†µí•´ AssumeRoleì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê·¸ ê²°ê³¼ ë°œê¸‰ëœ í† í° `Credentials`ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ì‹œ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ë§Œë“­ë‹ˆë‹¤. ì´ ì„¸ì…˜ê°’ì„ í†µí•´ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<div class="file-name">tests/conftest.py</div>

```python
@pytest.fixture(scope="session", name="assume_role_session")
def setup_role_credentials(aws_user_session: Session):
    role_arn = os.getenv("ROLE_ARN")

    credentials = assume_role(aws_user_session, role_arn)

    session = boto3.Session(
        aws_access_key_id=credentials["AccessKeyId"],
        aws_secret_access_key=credentials["SecretAccessKey"],
        aws_session_token=credentials["SessionToken"],
        region_name=os.getenv("AWS_REGION"),
    )

    logging.info("Role credentials are generated successfully")

    sts = session.client("sts")
    logging.info(sts.get_caller_identity())

    return session


def assume_role(aws_user_session: Session, role_arn: str):
    sts_client = aws_user_session.client("sts")

    response = sts_client.assume_role(
        RoleArn=role_arn, RoleSessionName="boto3-assume-session"
    )

    return response["Credentials"]
```

### 5. AssumeRole ì„¸ì…˜

ì´ì œ AssumeRoleì„ í†µí•´ ì „í™˜ëœ ì„¸ì…˜ì— í• ë‹¹ëœ ê¶Œí•œìœ¼ë¡œ ê°œë°œì„ ì§„í–‰í•©ë‹ˆë‹¤. ì•„ë˜ì˜ ì½”ë“œëŠ” `SecureGroup`ì„ ê°€ì ¸ì™€ì„œ ì¶œë ¥í•˜ëŠ” ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.

<div class="file-name">src/ec2.py</div>

```python
import logging


def hello_ec2(ec2_resource):
    logging.info("Hello, Amazon EC2! Let's list up to 10 of your security groups:")
    for sg in ec2_resource.security_groups.limit(10):
        logging.info(f"\t{sg.id}: {sg.group_name}")
```

<div class="file-name">tests/test_ec2.py</div>

```python
import pytest

from src.ec2 import hello_ec2


class TestEC2:
    @pytest.fixture(autouse=True)
    def setup(self, assume_role_session):
        self.session = assume_role_session
        self.ec2_resource = session.resource("ec2")

    def test_hello_ec2(self):
        hello_ec2(self.ec2_resource)
```

## ì •ë¦¬

---

Access keyë¥¼ ê·¸ëŒ€ë¡œ ê°œë°œí™˜ê²½ì— ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë³´ì•ˆìƒ ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ AssumeRoleì„ í†µí•œ ê°œë°œí™˜ê²½ì„ êµ¬ì¶•í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œëŠ” AWS CLIì™€ AWS SDKì—ì„œ `AssumeRole`ì„ í†µí•´ ë°œê¸‰ë°›ì€ í† í°ì„ í™œìš©í•˜ëŠ” ê°œë°œí™˜ê²½ì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤. ì´ì œ êµ¬ì„±ëœ í™˜ê²½ì„ ë°”íƒ•ìœ¼ë¡œ ì•„ë˜ì˜ URL ë§í¬ë¥¼ í†µí•´ì„œ ë” ë§ì€ AWS ì„œë¹„ìŠ¤ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ê³  ê³µë¶€í•´ ë³´ì‹œê¸¸ ë°”ëë‹ˆë‹¤! ğŸ˜Š

### AWS CLI

- [AWS CLI Command Reference](https://docs.aws.amazon.com/cli/latest){:target="_blank"}

### AWS SDK

- [Boto3 documentation](https://boto3.amazonaws.com/v1/documentation/api/latest/index.html){:target="_blank"}
- [AWS SDK Code Examples](https://github.com/awsdocs/aws-doc-sdk-examples){:target="_blank"}
