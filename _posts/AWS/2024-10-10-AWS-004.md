---
layout: post
date: 2024-10-10
catalogue: "AWS"
subject: "AWS"
title: "AWS EC2 프록시 서버 만들기"
sub_title: "헤외 티켓 예매를 위한 프록시(Proxy) 서버를 만들어 보자"
author: tiaz
permalink: /AWS/4
tags: [AWS, Proxy]
---

## 해외 티켓 예매

---

여행 가기 전에 꼭 해야하는게 있습니다. 필요한 예약을 해두는 것이죠. 일본 지브리 파크나 스페인 기차 예약 등, 반대로 해외에서 국내 OTT 서비스를 보고 싶을 때가 있습니다. 하지만 서비스를 사용 할 수 없는 경우도 자주 있습니다.

![지브리](/assets/img/content/AWS/004/001.png)

`> 지브리 박물관은 두달 전에 예약을 해야한다.`{:.img-caption}

해당 서비스 서버가 IP를 확인해서 자국 IP가 아닌, 해외에서 들어오는 공인 IP를 확인하고 차단하기 때문입니다. 그래서 우리는 또 이걸 우회한다고 미국 / 일본 IP로 변환해주는 VPN 앱을 사용합니다.

## VPN (Virtual Private Network)과 전용 회선

---

먼저 전용 회선에 대해서 알아보겠습니다. 말 그대로 종단과 종단을 물리적으로 직접 연결하는 것을 말합니다. AWS도 Direct Connect 같은 서비스가 있습니다.

반면 [VPN(Virtual Private Network)](https://docs.aws.amazon.com/ko_kr/vpn/latest/s2svpn/Examples.html#SingleVPN){:target='_blank'}은 이름에서도 알 수 있듯, 공중망에 직접 연결되는 것 같은 가상의 통로를 만드는 터널링 기술입니다. 거기다 추가적인 보안 프로토콜(IPsec, SSL)을 제공해 줍니다.

![AWS VPN](/assets/img/content/AWS/004/002.png)

`> 단일 Site-to-Site VPN 연결`{:.img-caption}

## 프록시(Proxy)

---

여기서는 VPN을 대신해, AWS EC2를 이용하여 간단하게 프록시(Proxy) 서버를 만들어서 IP를 우회하는 것을 해보겠습니다. 그렇다면 프록시는 어떤 기술일까요?

> proxy <br/> &nbsp; - 대리/위임(권) <br/> &nbsp; - 대리인

프록시는 단어의 뜻 그대로 네트워크 통신에서 중개자 역할을 수행합니다. 클라이언트와 서버 사이에서 요청(Request)과 응답(Response)을 중계합니다. 클라이언트는 프록시에 요청을 보내고, 프록시가 서버에 요청을 전달합니다.

### 프록시의 종류

- 포워드 프록시(Forward Proxy) : 클라이언트 측에서 사용
- 리버스 프록시(Reverse Proxy) : 서버 측에서 사용

NGINX가 서버 앞에서 먼저 요청을 받아서 서버에 전달하는 대표적인 리버스 프록시입니다. 우리가 만들 프록시는 클라이언트에서 동작하는 포워드 프록시 입니다.

## 프록시 구성방법 두 가지

---

두 가지 방법으로 EC2를 프록시로 사용해 보겠습니다.

- SSH 터널링 EC2 프록시
- GOST(Go Simple Tunnel) 사용

## SSH 터널링 프록시

---

EC2를 SSH 터너링을 사용해서 프록시로 만들어 보겠습니다. 이 방식은 아래 *그림 1.*과 같이 동작 합니다.

1. 로컬 컴퓨터와 EC2 간에 SSH Tunnel 생성
2. 브라우저에서 SSH Tunnel로 프록시를 설정

브라우저의 요청이 SSH Tunnel을 통해 실제 트래픽이 EC2를 통해 나가고 들어와서 브라우저로 전달되는 방식 입니다.

<pre class="mermaid center">
architecture-beta
    group client(custom:computer)[Local Computer]
        service server(custom:chrome)[Browser] in client
        service server2(custom:tunnel)[SSH Tunnel] in client

    service server3(aws:ec2)[EC2]

    service server4(custom:internet)[Ticket Server]

    server:R -- L:server2
    server2:R -- L:server3
    server3:R -- L:server4
</pre>
`> 그림 1. SSH 터널링 프록시`{:.img-caption}

### EC2 설정

인터넷 게이트웨이가 연결되어 있는 Public 서브넷에 아래와 같은 설정으로 EC2를 세팅 하도록 하겠습니다.

- 리전 : 도쿄 ap-northeast-1
- AWS EC2
  - Amazon Linux 2023
  - 키 페어 설정
  - 퍼블릭 IP 자동 할당 : 활성화
  - 보안그룹(SG) 인바운드 규칙 추가 : 내 아이피 / port 22

### MobaXterm 터널링

여기서는 [MobaXterm](https://mobaxterm.mobatek.net/download.html)을 사용하여 터널링을 생성해 보겠습니다. 상단에 `Tunneling` 메뉴를 선택하겠습니다.

![MobaXterm](/assets/img/content/AWS/004/003.png){:.img-m}

### New SSH tunnel

MobaSSHTunnel 창에서 하단에 `New SSH tunnel` 버튼을 선택하여 터널링을 생성하겠습니다.
상단에 `Dynamic port forwarding (SOCKS proxy)` 선택하고 아래의 정보를 입력 합니다.

1. `Forwarded port` : 8080 입력
2. SSH 서버(EC2) 정보 입력
    - `SSH server` : EC2 public ip
    - `SSH login` : ec2-user
    - `SSH port` : 22

![New SSH tunnel](/assets/img/content/AWS/004/004.png){:.img-m}
`> 그림 2. SSH 터널링 프록시`{:.img-caption}

### tunnel start

만들어둔 tunnel을 실행하겠습니다. 로컬 컴퓨터와 프록시로 사용 할 EC2 간에 터널링을 생성 됐습니다. 로컬 컴퓨터에서 8080 포트를 사용하면 SSH tunnel을 통해 EC2로 트래픽이 전달됩니다.

![New SSH tunnel](/assets/img/content/AWS/004/006.png)

### Chrome Extension : Proxy SwitchyOmega

그럼 이제 크롬 브라우저가 생성된 SSH tunnel을 사용할 수 있게 8080 포트로 웹 프록시 설정을 해줘야 합니다. 웹 프록시는 [Proxy SwitchyOmega](https://chromewebstore.google.com/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif) 확장 프로그램을 사용하겠습니다.

![New SSH tunnel](/assets/img/content/AWS/004/005.png){:.img-m}

### 변경된 아이피 확인

크롬 브라우저가 SSH tunnel을 통해서 EC2를 프록시 서버로 사용하는 구성이 완성됐습니다. 이제 변경된 아이피를 확인해보겠습니다. 아래의 명령으로 공인 IP를 확인해 볼 수 있습니다. 또는 네이버에서 내 아이피로 검색해 프록시 서버로 사용되는 EC2의 IP와 동일한지 확인해보시면 됩니다!

```bash
$ curl -x http://localhost:8080 https://ifconfig.me
```

## GOST(Go Simple Tunnel) 사용

---

이번에는 SSH 터널을 직접 사용하지 않고, [GOST(Go Simple Tunnel)](https://github.com/ginuerzh/gost/blob/master/README_en.md)라는 서버를 EC2에 만들어서 사용해 보도록 하겠습니다.

<pre class="mermaid center">
architecture-beta
    group client(custom:computer)[Local Computer]
        service server(custom:chrome)[Browser] in client

    group EC2(aws:ec2)[EC2]
        service server3(custom:server)[GOST Proxy] in EC2

    service server4(custom:internet)[Ticket Server]

    server:R -- L:server3
    server3:R -- L:server4
</pre>

### EC2 설정

이전 EC2에 보안그룹 인바운드 규칙만 추가해도 상관없습니다.

- 리전 : 도쿄 ap-northeast-1
- AWS EC2
  - Amazon Linux 2023
  - 키 페어 설정
  - 퍼블릭 IP 자동 할당 : 활성화
  - 보안그룹(SG) 인바운드 규칙 추가 : **내 아이피 / port 8080**{:.orange}

### GOST(Go Simple Tunnel) 서버 실행

우선 도커를 설치 하겠습니다. GOST 이미지를 풀 받아서 제대로 동작하는지 확인 해보는 것 까지 해보겠습니다.

```bash
$ sudo yum install docker

$ sudo systemctl start docker

$ sudo docker run --rm ginuerzh/gost -V
```

GOST 컨테이너를 실행해 8080 포트를 매핑 해놓고 웹 브라우저에서 트래픽이 오는지 기다리고 있겠습니다.

```bash
$ sudo docker run --rm -p 8080:8080 ginuerzh/gost -L=:8080
```

### 웹 프록시 세팅

Proxy SwitchyOmega를 이용하여 프록시 서버를 EC2의 Public IP로 세팅 하겠습니다.

![New SSH tunnel](/assets/img/content/AWS/004/007.png){:.img-m}

### 변경된 아이피 확인

이제 로컬 컴퓨터의 공인 IP가 EC2의 Public IP로 변경됐는지 확인해 보시길 바랍니다!

```bash
$ curl -x http://localhost:8080 https://ifconfig.me
```

## 실무에서 쓰는 프록시

---

여기까지 두 가지 방법으로 EC2를 프록시로 사용해 보았습니다. 여기 마무리를 해도 좋겠지만, 프록시가 실제 업무에서 사용되는 경우가 있기 때문에 프록시 관련 세팅을 좀더 알아 보겠습니다.

### 언제 쓰나

프록시를 실무에서 쓰는 상황은 매우 특수한 경우에 사용될 수 있습니다. 바로 폐쇠망 환경에서 프록시 서버를 구성해야 하는 경우가 있습니다.

폐쇄망 환경에서 프록시를 사용하여 외부와의 연결 포인트를 하나로 통합하는데 사용 할 수 있습니다. 예를 들어 이를 통해 네트워크 보안과 관리 효율성을 크게 향상시킬 수 있습니다.

## Windows에서 프록시 설정

---

## Linux에서 프록시 설정

---

## 마무리

---
