---
layout: post
date: 2024-06-14
catalogue: "AWS"
subject: "AWS-Docker"
title: "Docker + EC2 배포"
excerpt: "Docker를 AWS EC2에 배포 해보기"
author: tiaz
permalink: /AWS/4
tags: [Docker, AWS]
---

1. AWS 구성 그리기
    - 그림으로
2. 수동 배포 구성해 보기
    - 간단하게 그냥 도커 설치하고 하는 세팅
    - 문제점 언급 : 내가 이미지 새로 풀 받고 런
3. Webhook & 쉘 스크립트 이용
    - docker hub - Webhook 세팅
    - uvicorn
    - 쉘 스크립트 작성
4. Watchtower
    - 설치
    - 옵션
5. 문제점
    - git 배포
    - 도커 빌드 배포
6. 마무리 : 다음으로
    - Pipeline 활용

## docker.com 가입

---

[docker.com](https://www.docker.com/)에 가입하고 로그인 합니다. 가입 할때 생성하는 `Username`은 도커 이미지를 저장하는 도커 허브(_Docker Hub_)에 사용되기 됩니다. 마치 *GitHub*와 유사한 형태의 원격 이미지 저장소라고 생각하면 됩니다.

![Docker Username](/assets/img/content/AWS/003/002.png){:.img-s}

## 도커 이미지 생성

---

### API 코드

배포 할 API 서버 코드를 먼적 작성하겠습니다. `fast-api`로 작성된 문자열을 반환하는 간단한 코드 입니다. `run.py` 파일에 코드를 작성하겠습니다.

```text
project/
└── run.py (추가 파일)
```

<div class="file-name">run.py</div>

```bash
from fastapi import FastAPI
from fastapi.responses import PlainTextResponse

app = FastAPI()

@app.get("/")
def health(response_class=PlainTextResponse):
    return "Hello Docker Container"
```

### Dockerfile 작성

Docker 이미지를 생성할 때 사용하는 `Dockerfile`을 작성하겠습니다.

```text
project/
├── Dockerfile (추가 파일)
└── run.py
```

```Dockerfile
FROM python:3.12-alpine

RUN pip install -U poetry

WORKDIR /app

COPY . .

RUN poetry install --no-root --no-interaction 

EXPOSE 8000

CMD ["poetry", "run", "uvicorn", "run:app", "--host", "0.0.0.0", "--port", "8000"]
```

### docker 이미지 생성

작성한 도커 파일(_Dockerfile_)을 사용하여 이미지를 빌드합니다.

```bash
$ docker build -t tiaz0128/fast-api .
```

### 이미지 _push_

빌드한 이미지를 도커 허브에 푸쉬하겠습니다. 우선 가입한 계정으로 로그인 합니다. 그리고 이미지를 생성 할때 작성한 태그를 기반으로 도커 허브에 이미지를 _push_ 할 수 있습니다.

```bash
$ docker login 

Username: tiaz0128.dev@gmail.com
Password:
```

```bash
WARNING! Your password will be stored unencrypted in /home/ec2-user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
```

```bash
$ docker push 
```

## AWS 구성

---

- 그림 + 설명

## Docker 설치

---

### docker 설치

**EC2**(_Amazon Linux 2023 AMI_)에서 `docker`를 먼저 설치하겠습니다.

```bash
$ sudo yum update -y
$ sudo yum -y install docker
```

### 데몬 & 권한 추가

설치 후에는 데몬을 켜 줍니다. 명령어 권한도 추가해줍니다.

```bash
$ sudo systemctl restart docker
$ sudo usermod -a -G docker ec2-user
```

### docker pull

도커 허브에 로그인 하고 빌드 한 이미지를 받습니다.

```bash
$ docker login 

Username: tiaz0128.dev@gmail.com
Password:
```

```bash
$ docker pull tiaz0128/fast-api
```

## 수동 배포의 문제점

---

여기까지 수동으로 도커 컨테이너를 배포해보았습니다. 그렇다면 여기서 이런 생각이 듭니다.

> 코드가 수정되고 이미지가 새로 만들어지면 어떻게 하지?

앞서 했던 것처럼 매번 수동으로 이미지를 풀(_pull_)받고 컨테이터를 재시작해야 할 것입니다. 

새로운 이미지가 배포되면 컨테이너를 재시작 하는 여러가지 방법이 있지만, 여기서는 두 가지를 알아보겠습니다.

- Docker hub : Webhooks
- Watchtower

## Docker hub : Webhooks

---

![1](/assets/img/content/AWS/003/001.png){:.img-m}

## Watchtower

---

https://containrrr.dev/watchtower/

```bash
docker run -d \
  --name watchtower \
  -v /var/run/docker.sock:/var/run/docker.sock \
  containrrr/watchtower
```

### 주요 옵션

- -\-interval \<sec\>: 업데이트 확인 주기 설정
- -\-cleanup: 이전 이미지 자동 삭제

Watchtower를 사용하면 수동 개입 없이 컨테이너를 최신 상태로 유지할 수 있습니다.


## 남은 과제

---

git 배포와 docker 이미지 배포를 각각 수행해야 하는 불편함이 남아있습니다.

## 마무리

---
