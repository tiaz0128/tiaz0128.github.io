---
layout: post
date: 2024-10-02
catalogue: "Network"
subject: "SSL"
title: "https를 위한 SSL 인증서 발급"
excerpt: "자체 서명된 인증서 → Let's Encrypt → CA 인증"
author: tiaz
permalink: /Network/1
tags: [SSL]
---

## SSL(Secure Sockets Layer)과 인증서 개념

---

### SSL(Secure Sockets Layer)

SSL은 웹 통신을 암호화하고 보안을 유지하는 프로토콜입니다. 네스케이프에 의해서 처음 만들어지고 그 이후 표준화 관리 명칭은 TLS(Transport Layer Security)로 부릅니다. 하지만 일반적으로 SSL이라는 용어를 더 많이 사용하고 있습니다.

### 인증서

인증서는 SSL/TLS 통신의 핵심 요소로, 다음과 같은 중요한 정보를 포함합니다.

1. 서비스 정보
   - 도메인 이름
   - 조직 이름
   - 위치 정보 등

2. 서버 측 공개키
   - 공개키 자체
   - 사용된 암호화 알고리즘 (예: RSA, ECC 등)

### 인증서 검증 과정

<pre class="mermaid center">
%%{
  init: {
    'theme': 'base',
    'themeVariables': {
      'primaryColor': '#2a3844',
      'primaryTextColor': '#fff',
      'primaryBorderColor': '#fff',
      'tertiaryColor': '#fff'
    }
  }
}%%

sequenceDiagram
    participant WS as 웹 서버
    participant CA as CA (인증기관)
    participant WB as 웹 브라우저

    WS-&gt;&gt;CA: 1. 인증 요청
    CA-&gt;&gt;CA: 2. 서버 정보를 검증하고 인증서 생성
    CA--&gt;&gt;WS: 3. CA의 비밀키로 인증서 서명
    WS-&gt;&gt;WS: 4. 서버로 서명된 인증서 발급
    WB-&gt;&gt;CA: 5. 웹 브라우저에 CA의 공개키 제공
    WB-&gt;&gt;WS: 6. 서버(웹 사이트) 접속 요청
    WS--&gt;&gt;WB: 7. 발급받은 인증서 전달
    WB-&gt;&gt;WB: 8. CA 공개키로 인증서 검증
    WB-&gt;&gt;WB: 9. 서버 공개키로 대칭키 암호화
    WB--&gt;&gt;WS: 10. 서버로 암호화된 대칭키 전송
    WS-&gt;&gt;WS: 11. 서버 비밀키로 대칭키 복호화
    WS &lt;&lt;-&gt;&gt; WB: 12. 대칭키를 이용하여 암호화된 정보를 주고받는다.
</pre>

1. 브라우저가 웹사이트에 접속하면 서버는 인증서를 제공합니다.
2. 브라우저는 신뢰할 수 있는 인증 기관(CA, Certificate Authority)의 목록을 가지고 있습니다. 이를 "루트 인증서"라고 합니다.
3. 브라우저는 받은 인증서가 신뢰할 수 있는 CA에 의해 서명되었는지 확인합니다.
4. 서명이 유효하면, 브라우저는 해당 웹사이트를 신뢰하고 암호화된 연결을 설정합니다.

### SSL 보안 이점

- 데이터 암호화: 통신 내용을 제3자가 읽을 수 없게 합니다.
- 무결성 보장: 데이터가 전송 중에 변조되지 않았음을 확인할 수 있습니다.
- 인증: 사용자가 의도한 정확한 웹사이트와 통신하고 있음을 보장합니다.

## SSL 인증서 종류

---

암호화 수준이 아닌 심사에 따른 보안 수준을 의미

- DV
- OV
- EV

## 서버 세팅

---

- EC2
- [nginx 설치](https://nginx.org/en/linux_packages.html)
- 퍼블릭 IPv4 DNS
- 퍼블릭 IPv4 주소

```bash
$ sudo yum install yum-utils
```

```bash
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/amzn/2023/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
priority=9

[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/amzn/2023/$basearch/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
priority=9
```

```bash
$ sudo yum install nginx
```

## 자체 서명된 SSL 인증서

---

- 브라우져 에러
- 인증서 확인 가능

자체 서명된 SSL 인증서를 NGINX에 적용하는 과정을 단계별로 설명해 드리겠습니다:

```bash
$ sudo mkdir /etc/nignx/ssl
```

1. SSL 인증서 생성:
먼저 OpenSSL을 사용하여 자체 서명된 SSL 인증서를 생성합니다.

```bash
$ sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/self.key -out /etc/nginx/ssl/self.crt
```

이 명령은 1년간 유효한 2048비트 RSA 키 쌍과 자체 서명된 인증서를 생성합니다. 명령을 실행하면 인증서 정보를 입력하라는 프롬프트가 나타납니다.

2. NGINX 설정 파일 수정:
SSL을 사용하도록 NGINX 설정을 변경해야 합니다. /etc/nginx/conf.d/ 디렉토리에 새 설정 파일을 만들거나 기존 파일을 수정합니다.

```bash
sudo vim /etc/nginx/conf.d/default.conf
```

다음과 같이 설정을 추가하거나 수정합니다:

```nginx
server {
    listen 443 ssl;
    server_name ec2-3-38-109-145.ap-northeast-2.compute.amazonaws.com;

    ssl_certificate /etc/nginx/ssl/self.crt;
    ssl_certificate_key /etc/nginx/ssl/self.key;

    # SSL 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;

    # 나머지 서버 설정
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
}

# HTTP에서 HTTPS로 리다이렉트
server {
    listen 80;
    server_name ec2-3-38-109-145.ap-northeast-2.compute.amazonaws.com;

    # 모든 요청은 HTTPS로 리다이렉트
    location / {
        return 301 https://$server_name$request_uri;
    }
}
```

3. NGINX 설정 테스트:
설정 파일을 수정한 후, 구문 오류를 확인합니다.

```bash
sudo nginx -t
```

4. NGINX 재시작:
설정이 올바르다면 NGINX를 재시작하여 변경사항을 적용합니다.

```bash
sudo systemctl restart nginx
```

![자체 서명 인증서](/assets/img/content/Network/001/001.png){:.img-m}

`> 자체 서명 된 인증서를 확인 가능`{:.img-caption}

이제 자체 서명된 SSL 인증서가 NGINX에 적용되었습니다. 브라우저에서 https://your_domain.com으로 접속하면 보안 연결이 설정되었음을 확인할 수 있습니다. 다만, 자체 서명된 인증서이기 때문에 브라우저에서 보안 경고가 표시될 수 있습니다.

실제 운영 환경에서는 신뢰할 수 있는 인증 기관(CA)에서 발급받은 인증서를 사용하는 것이 좋습니다. Let's Encrypt와 같은 무료 SSL 인증서 제공 서비스를 고려해 보시는 것도 좋습니다.

## Let's Encrypt : certbot 활용

---

Let's Encrypt는 무료로 SSL/TLS 인증서를 제공하는 인증 기관입니다. Let's Encrypt를 사용하여 인증서를 발급받는 가장 일반적인 방법은 Certbot이라는 도구를 사용하는 것입니다. 여기에 그 과정을 단계별로 설명하겠습니다.

### 1. Certbot 설치

```bash
sudo yum install certbot
```

2. 인증서 발급:

Certbot은 여러 가지 플러그인을 제공하여 다양한 웹 서버와 통합할 수 있습니다. 여기서는 Nginx를 예로 들겠습니다.

```bash
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
```

이 명령어는 다음 작업을 수행합니다:
- Let's Encrypt에서 인증서를 발급받습니다.
- Nginx 설정을 자동으로 업데이트하여 SSL을 활성화합니다.
- HTTP에서 HTTPS로의 리다이렉션을 설정합니다 (선택 사항).

만약 Apache를 사용한다면, `--nginx` 대신 `--apache` 옵션을 사용하면 됩니다.

3. 독립 실행 모드:

웹 서버가 없거나 수동으로 설정하고 싶다면, 독립 실행 모드를 사용할 수 있습니다:

```bash
sudo certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com

```

이 모드에서는 Certbot이 일시적으로 자체 웹 서버를 실행하여 인증 과정을 진행합니다.

4. 자동 갱신 설정:

Let's Encrypt 인증서는 90일 후에 만료되므로 정기적인 갱신이 필요합니다. Certbot은 자동 갱신 기능을 제공합니다.

대부분의 시스템에서 Certbot 설치 시 자동으로 갱신 크론 작업이 설정됩니다. 확인하려면:

```bash
sudo systemctl list-timers | grep certbot

# 또는

ls -l /etc/cron.*/ | grep certbot

```

수동으로 갱신을 테스트하려면:

```bash
sudo certbot renew --dry-run

```

5. 인증서 정보 확인:

발급받은 인증서의 정보를 확인하려면:

```bash
sudo certbot certificates

```

주의사항 및 팁:

1. 포트 개방: Certbot이 작동하려면 80번(HTTP)과 443번(HTTPS) 포트가 외부에서 접근 가능해야 합니다.

2. 테스트 환경: Let's Encrypt는 테스트용 서버도 제공합니다. `--test-cert` 옵션을 사용하여 테스트 인증서를 발급받을 수 있습니다.

3. 속도 제한: Let's Encrypt에는 속도 제한이 있어서, 짧은 시간 동안 너무 많은 인증서를 요청하면 일시적으로 차단될 수 있습니다.

4. 와일드카드 인증서: DNS 챌린지를 통해 와일드카드 인증서를 발급받을 수 있지만, 과정이 좀 더 복잡합니다.

5. 웹 서버 재시작: 인증서 갱신 후 웹 서버를 재시작해야 할 수 있습니다. Certbot의 갱신 후크를 사용하여 이 과정을 자동화할 수 있습니다.

Let's Encrypt와 Certbot을 사용하면 무료로 쉽게 SSL/TLS 인증서를 발급받고 관리할 수 있습니다. 이는 웹사이트의 보안을 향상시키고 HTTPS를 구현하는 데 매우 유용한 도구입니다.

## CA 인증

---

Your Private Server Key

Order Status - Incomplete

Generate Certificate

CSR

Domain Validation
파일 업로드 또는, 내용 붙여넣기
nginx 추가

```bash
$ sudo vim /usr/share/nginx/html/pki.txt
```

alias 지시어를 사용하여 특정 파일을 직접 지정

```nginx
server {
    listen 443 ssl;
    server_name ec2-3-36-45-120.ap-northeast-2.compute.amazonaws.com;

    ...

    # 인증 파일에 접근할 수 있도록 설정
    location = /.well-known/pki-validation/350105A2F3AE57EAEB998A011B60C5B9.txt {
        alias /usr/share/nginx/html/pki.txt;
    }
}
```

에러 확인

```bash
$ sudo tail -f /var/log/nginx/error.log
```

ALL 파일 다운로드

## fullchain.crt 파일 생성

---

```bash
$ cat 도메인_인증서.crt 중간_인증서.crt > GoGetSSL_fullchain.crt

$ cat ec2-3-36-45-120_ap-northeast-2_compute_amazonaws_com.crt GoGetSSL_RSA_DV_CA.crt USERTrust_RSA_Certification_Authority.crt > /etc/nginx/ssl/GoGetSSL_fullchain.crt
```

풀체인 파일은 SSL/TLS 인증서 체인을 구성하는 여러 인증서를 하나의 파일로 결합한 것입니다. 귀하가 언급한 파일들의 역할은 다음과 같습니다:

1. ec2-3-36-45-120_ap-northeast-2_compute_amazonaws_com.crt
   - 역할: 서버(도메인) 인증서
   - 설명: 이것은 귀하의 특정 도메인이나 서버에 대해 발급된 인증서입니다. 이 인증서는 귀하의 서버가 주장하는 신원을 확인합니다.

2. GoGetSSL_RSA_DV_CA.crt
   - 역할: 중간 인증서 (Intermediate Certificate)
   - 설명: 이 인증서는 루트 인증 기관(CA)과 귀하의 서버 인증서 사이의 "중간" 링크 역할을 합니다. 이는 신뢰 체인을 구축하는 데 도움이 됩니다.

3. USERTrust_RSA_Certification_Authority.crt
   - 역할: 루트 인증서 (Root Certificate)
   - 설명: 이는 신뢰 체인의 최상위에 있는 인증서입니다. 대부분의 브라우저와 운영 체제에 이미 신뢰할 수 있는 인증서로 포함되어 있습니다.

풀체인 파일을 만들 때의 일반적인 순서:

1. 서버(도메인) 인증서
2. 중간 인증서
3. 루트 인증서 (선택적)

이렇게 순서대로 결합하는 이유:

1. 클라이언트(브라우저)는 먼저 서버 인증서를 확인합니다.
2. 그 다음 중간 인증서를 사용하여 서버 인증서의 발급자를 확인합니다.
3. 마지막으로 루트 인증서를 확인하여 전체 체인의 신뢰성을 검증합니다.

NGINX에서 이 풀체인 파일을 사용할 때는 `ssl_certificate` 지시어에 이 파일을 지정하면 됩니다. 개인 키 파일은 별도로 `ssl_certificate_key` 지시어에 지정해야 합니다.

## nginx 설정

---

```nginx
server {
    listen 443 ssl;
    server_name ec2-3-36-45-120.ap-northeast-2.compute.amazonaws.com;

    ssl_certificate /etc/nginx/ssl/GoGetSSL_fullchain.crt;
    ssl_certificate_key /etc/nginx/ssl/GoGetSSL_private.key;

    # SSL 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;

    # 나머지 서버 설정
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    # HTTP 인증 파일에 접근할 수 있도록 설정
    location = /.well-known/pki-validation/257021C3E8573B411207306E67F363E5.txt {
        alias /usr/share/nginx/html/pki.txt;
    }
}

# HTTP에서 HTTPS로 리다이렉트
server {
    listen 80;
    server_name ec2-3-36-45-120.ap-northeast-2.compute.amazonaws.com;

    # 다른 모든 요청은 HTTPS로 리다이렉트
    location / {
        return 301 https://$server_name$request_uri;
    }
}
```
