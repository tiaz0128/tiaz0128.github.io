---
layout: post
date: 2024-05-06
catalogue: "gRPC"
subject: "gRPC"
title: "gRPC 실전"
excerpt: "gRPC 기본적인 사용 방법에 대해서"
author: tiaz
permalink: /gRPC/2
tags: [gRPC]
---

*마이크로서비스 아키텍처(MSA)*에서 많이 언급되는 `gRPC`에 대해서 알아보겠습니다.

## RPC (Remote Procedure Call)

---

`RPC`는 클라이언트-서버 모델을 기반으로 원격 프로시저를 로컬 프로시저처럼 호출할 수 있게 해주는 프로토콜입니다.

### 작동 방식

1. 클라이언트가 로컬에서 함수를 호출
2. RPC 시스템이 호출을 직렬화하여 네트워크로 전송
3. 서버에서 요청을 받아 역직렬화하고 해당 함수 실행
4. 결과를 다시 직렬화하여 클라이언트로 전송
5. 클라이언트에서 결과를 받아 역직렬화하여 사용

![gRPC](/assets/img/content/gRPC/002/001.png){:.img-m}

## gRPC (gRPC Remote Procedure Calls)

---

`gRPC`는 Google에서 개발한 오픈소스 RPC 프레임워크로, 고성능의 범용 RPC 프레임워크입니다.

![gRPC](/assets/img/title/gRPC/gRPC.png){:.img-2x2}

### 주요 특징

- `protobuf`를 IDL(Interface Definition Language)로 사용
- HTTP/2 기반의 통신
- 양방향 스트리밍 지원
- 다양한 프로그래밍 언어 지원

### 작동 방식

- protobuf로 서비스 정의
- 서비스 정의를 기반으로 서버와 클라이언트 코드 생성
- gRPC 런타임을 사용하여 클라이언트-서버 통신

## 코드

---

<div class="file-name">protos/person.proto</div>

```text
syntax = "proto3";

message Person {
    string name = 1;
    int32 age = 2;
    enum Gender {
        UNKNOWN = 0;
        MALE = 1;
        FEMALE = 2;
    }
    Gender gender = 3;
    repeated string hobbies = 4;
    
    message Address {
        string street = 1;
        string city = 2;
    }
    Address address = 5;
}
```

<div class="file-name">protos/route_guide.proto</div>

```text
syntax = "proto3";

import "person.proto";

service RouteGuide {
    rpc GetPerson(Name) returns (Person) {}
    rpc GetPeople(stream Name) returns (stream Person) {}
}

message Name {
  string name = 1;
}
```

### 컴파일

src 폴더에서 아래의 컴파일 명령어를 실행합니다. `protos/` 아래에 있는 _.proto_ 파일들을 대상으로 컴파일 합니다. 컴파일 결과 파일은 src 폴더에 생성 됩니다.

```text
project/
├── protos/
│   └── person.proto
│   └── route_guide.proto
└── src/
    └── (현재 위치)
```

```bash
$ python -m grpc_tools.protoc -I=../protos --python_out=. --pyi_out=. --grpc_python_out=. ../protos/*.proto
```

### 생성 파일

컴파일 결과 각 .proto 파일에 대해 일반적으로 3개의 Python 파일이 생성됩니다. 각 파일의 기능을 알아봅시다.

```text
project/
├── protos/
│   └── person.proto
│   └── route_guide.proto
└── src/
    └── person_pb2_grpc.py (현재 위치)
    └── person_pb2.py
    └── person_pb2.pyi
    └── route_guide_pb2_grpc.py
    └── route_guide_pb2.py
    └── route_guide_pb2.pyi
```

## 컴파일 결과 파일

---

### `*_pb2.py` 파일

protobuf 메시지(message)를 정의하는 파일입니다. 데이터 구조를 정의하고 조작하는 데 사용합니다.

- .proto 파일에서 정의한 모든 메시지 타입에 대한 Python 클래스
- 각 필드에 대한 getter와 setter 메서드
- 직렬화(serialization)와 역직렬화(deserialization) 메서드

### `*_pb2_grpc.py` 파일

gRPC 서비스(service)를 정의하는 파일입니다. gRPC 서버 구현 및 클라이언트에서 서비스 호출에 사용합니다.

- 서버 측: 서비스 구현을 위한 Servicer 클래스
- 클라이언트 측: 서비스 호출을 위한 Stub 클래스
- 서비스를 gRPC 서버에 등록하기 위한 함수

### `*_pb2.pyi` 파일

타입 힌팅(Type Hinting) 정보를 제공합니다. IDE나 mypy 같은 타입 체커에서 타입 검사 지원하며, 코드 자동 완성 및 문서화 개선하는 역할을 합니다.

- *_pb2.py에 정의된 클래스와 함수의 타입 정보
- 메시지 필드의 타입, 메서드의 파라미터 및 반환 등

이 세 파일을 통해 개발자는 타입 안정성을 유지하면서 효율적으로 protobuf 메시지를 다루고 gRPC 서비스를 구현할 수 있습니다. *_pb2.pyi 파일은 선택적이지만, 대규모 프로젝트나 타입 안정성이 중요한 경우에 매우 유용합니다.

## server 구현

---

### 파일 생성

```text
project/
├── protos/
│   └── person.proto
│   └── route_guide.proto
└── src/
    └── *server.py (추가 파일)
    └── ...
```

### 코드

<div class="file-name">src/server.py</div>

```python
import grpc
from concurrent import futures
import person_pb2
import route_guide_pb2
import route_guide_pb2_grpc


class RouteGuideServicer(route_guide_pb2_grpc.RouteGuideServicer):
    def __init__(self):
        self.people = {
            "Alice": person_pb2.Person(
                name="Alice",
                age=30,
                gender=person_pb2.Person.FEMALE,
                hobbies=["reading", "swimming"],
                address=person_pb2.Person.Address(
                    street="123 Main St", city="New York"
                ),
            ),
            "Bob": person_pb2.Person(
                name="Bob",
                age=25,
                gender=person_pb2.Person.MALE,
                hobbies=["gaming", "cycling"],
                address=person_pb2.Person.Address(
                    street="456 Elm St", city="Los Angeles"
                ),
            ),
        }

    def GetPerson(self, request, context):
        name = request.name
        return self.people.get(name, person_pb2.Person(name="Not Found"))

    def GetPeople(self, request_iterator, context):
        for name_request in request_iterator:
            person = self.people.get(name_request.name)
            if person:
                yield person


def serve():
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    route_guide_pb2_grpc.add_RouteGuideServicer_to_server(RouteGuideServicer(), server)
    server.add_insecure_port("[::]:50051")
    print("Server started on port 50051")
    server.start()
    server.wait_for_termination()


if __name__ == "__main__":
    serve()
```

### 서버 구동

```bash
$ python server.py
```

## client 구현

---

### 파일 생성

```text
project/
├── protos/
│   └── person.proto
│   └── route_guide.proto
└── src/
    └── *client.py (생성 파일)
    └── server.py
    └── ...
```

### 코드

<div class="file-name">src/client.py</div>

```python
import grpc
import route_guide_pb2
import route_guide_pb2_grpc

def run():
    with grpc.insecure_channel('localhost:50051') as channel:
        stub = route_guide_pb2_grpc.RouteGuideStub(channel)

        # GetPerson 호출
        name = route_guide_pb2.Name(name="Alice")
        person = stub.GetPerson(name)
        print(f"GetPerson: {person.name}, Age: {person.age}, Gender: {person.gender}, "
              f"Hobbies: {person.hobbies}, Address: {person.address.street}, {person.address.city}")

        # GetPeople 호출
        names = [route_guide_pb2.Name(name="Alice"), route_guide_pb2.Name(name="Bob"), route_guide_pb2.Name(name="Charlie")]
        people = stub.GetPeople(iter(names))
        for person in people:
            print(f"GetPeople: {person.name}, Age: {person.age}, Gender: {person.gender}, "
                  f"Hobbies: {person.hobbies}, Address: {person.address.street}, {person.address.city}")

if __name__ == '__main__':
    run()
```

### 클라이언트 구동

```bash
$ python client.py
```

```bash
GetPerson: Alice, Age: 30, Gender: 2, Hobbies: ['reading', 'swimming'], Address: 123 Main St, New York

GetPeople: Alice, Age: 30, Gender: 2, Hobbies: ['reading', 'swimming'], Address: 123 Main St, New York
GetPeople: Bob, Age: 25, Gender: 1, Hobbies: ['gaming', 'cycling'], Address: 456 Elm St, Los Angele
```
