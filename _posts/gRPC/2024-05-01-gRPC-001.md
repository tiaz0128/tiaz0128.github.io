---
layout: post
date: 2024-05-01
catalogue: "gRPC"
subject: "gRPC"
title: "gRPC 기초 : Protocol Buffers"
excerpt: "gRPC를 위한 기본 Protocol Buffers를 알아보자."
author: tiaz
permalink: /gRPC/1
tags: [gRPC, protobuf]
---

gRPC를 공부 하기전에 기본이 되는 `Protocol Buffers`를 먼저 알아보겠습니다.

## Protocol Buffers

---

`Protocol Buffers`는 구글에서 만든 이진 직렬화 포맷입니다. 줄여서 `protobuf`라고 부릅니다. JSON, YAML, XML과 같은 데이터를 표현하는 포맷입니다.  익숙한 포맷들과 가장 큰 차이는 데이터를 이진 데이터로 표현한다는 점입니다. `protobuf`의 장단점은 아래와 같습니다.

### 장점

- 직렬화와 역직렬화가 매우 빠름
- 데이터 크기가 작아 네트워크 전송이 효율적
- 다양한 프로그래밍 언어(Java, Python, C++, Go 등)에서 사용 가능
- 컴파일 시점에 타입 체크를 수행하여 런타임 오류

### 단점

- 이진 형식이라 사람이 직접 읽기 어렵고 디버깅이 어려움
- .proto 파일 작성과 protobuf 사용법을 학습
- 웹 브라우저에서 직접 사용하기 어렵움
- 간단한 데이터 교환의 경우, JSON이나 XML에 비해 과도하게 복잡

## protobuf 설치

---

[gRPC에 나와있는 설치 방법](https://grpc.io/docs/protoc-installation/){:target="_blank"} 페이지를 참고하여 설치를 진행합니다. 아래의 세 가지 방법을 추천합니다. 여기서는 `python` 모듈을 설치하도록 하겠습니다.

- 각 언어별 모듈 설치
- brew 이용
- 컴파일된 바이너리 다운로드

### 🚨 주의

`apt`를 통해 설치되는 버젼이 매우 낮을 수 있습니다. 반드시 [최신의 버젼](https://github.com/protocolbuffers/protobuf/releases){:target="_blank"}인지 확인 합니다. `apt`를 통한 설치는 추천하지 않습니다.

```bash
# 추천하지 않음
$ apt install protobuf-compiler
```

### python 모듈 설치

- Python `3.7` 이상
- pip version 9.0.1 이상

```bash
$ pip install grpcio-tools
```

```bash
$ python -m grpc_tools.protoc --version
```

## .proto 작성

---

우선 가장 먼저 `.proto` 라는 스키마 파일을 작성해야 합니다. 해당 파일을 컴파일 하여 각 언어별로 `protobuf`를 사용할 수 있는 파일을 만들 수 있습니다. 일종의 인터페이스 코드를 생성 한다고 생각하면 됩니다.

기본적인 JSON 형태의 데이터를 `.proto`로 비교하면서 작성해보겠습니다.

### JSON

```json
{
    "person": {
        "name": "tiaz0128"
    }
}
```

### .proto 작성

protos 폴더 아래 `person.proto`라는 파일 작성하겠습니다.

`syntax = "proto3" 3버전을 사용하겠다는 의미이며 주로 3버젼을 사용합니다. syntax 구문을 작성하지 않으면 2버젼을 기본으로 사용하기 때문에 반드시 작성해 줍니다.

<div class="file-name">protos/person.proto</div>

```text
syntax = "proto3";

message Person {
  string name = 1;
}

message Data {
  Person person = 1;
}
```

## .proto 컴파일

---

### src 폴더

`src` 폴더를 만들고 해당 위치에서 아래의 컴파일 명령을 실행합니다.

```text
project/
├── protos/
│   └── person.proto
└── src/
    └── (현재 위치)
```

### protoc

작성한 `.proto` 파일을 컴파일해서 파이썬 코드를 만들어 냅니다.

```bash
$ python -m grpc_tools.protoc -I../protos --python_out=. ../protos/person.proto
```

- `I../protos` : proto 파일을 찾을 디렉토리를 지정합니다.
- `-python_out=.` : 생성된 Python 코드를 현재 디렉토리에 출력합니다.
- `../protos/person.proto` : 컴파일할 proto 파일의 경로를 지정합니다.

### 결과 파일

`person.proto`파일을 이용해 `person_pb2.py`라는 파일이 생성됩니다. 결과 파일의 이름은 다음과 같은 규칙을 따릅니다.

1. `.proto` 파일의 이름을 기반으로 합니다.
2. `_pb2.py` 라는 접미사 붙은 형태로 만들어 집니다.

```text
project/
├── protos/
│   └── person.proto
└── src/
    └── person_pb2.py (결과 파일)
```

### _pb2.py

이 생성된 코드는 다음과 같은 내용을 포함합니다.

- Person 메시지 타입 정의
- PersonWrapper 메시지 타입 정의 (Person을 포함하는 래퍼)
- 각 메시지 타입에 대한 디스크립터 및 직렬화/역직렬화 메서드
