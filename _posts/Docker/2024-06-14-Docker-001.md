---
layout: post
ins_date: 2024-09-29
upd_date: 2025-01-23
category: "Docker"
subject: "Docker"
title: "Docker ë°°í¬ : ì‰½ê²Œ ì‹œì‘í•˜ê¸°"
description: "Docker ìˆ˜ë™ ë°°í¬ì™€ Watchtowerë¥¼ ì´ìš©í•œ ìë™ ì—…ë°ì´íŠ¸"
author: tiaz0128
permalink: /Docker/1
tags: [Docker, ci/cd]
next_post: /AWS/5
ref-link:
  - type: youtube
    url: 'https://youtu.be/iIrk4mqCS78?si=iaL-UDCXArCCjeGn'
    title: '[ë”°ë°°GitOps] ì† ì‰½ê²Œ í•œ ë²ˆì— ìµíˆëŠ” GitOps!'
---


## ë„ì»¤ ë°°í¬

ë„ì»¤ë¥¼ ì„œë²„ì— ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

- ìˆ˜ë™ ë°°í¬
- Watchtower
- AWS CodePipeline CI/CD êµ¬ì¶•

## Docker image ìƒì„±

### API ì½”ë“œ

ë°°í¬ í•  API ì„œë²„ ì½”ë“œë¥¼ ë¨¼ì € ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤. FastAPIë¡œ ì‘ì„±ëœ ë¬¸ìì—´ì„ ë°˜í™˜í•˜ëŠ” ê°„ë‹¨í•œ ì½”ë“œ ì…ë‹ˆë‹¤. `run.py` íŒŒì¼ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```text
project/
â””â”€â”€ run.py (ì¶”ê°€ íŒŒì¼)
```

<div class="file-name">run.py</div>

```python
from fastapi import FastAPI
from fastapi.responses import PlainTextResponse

app = FastAPI()

@app.get("/")
def health(response_class=PlainTextResponse):
    return "Hello Docker Container"
```

### Dockerfile ì‘ì„±

ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©í•˜ëŠ” `Dockerfile`ì„ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```text
project/
â”œâ”€â”€ Dockerfile (ì¶”ê°€ íŒŒì¼)
â””â”€â”€ run.py
```

<div class="file-name">Dockerfile</div>

```Dockerfile
FROM python:3.12-alpine

RUN pip install "fastapi[standard]"

WORKDIR /app

COPY . .

EXPOSE 8000

CMD ["uvicorn", "run:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Docker image ë¹Œë“œ

ì‘ì„±í•œ ë„ì»¤ íŒŒì¼(Dockerfile)ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤. ì´ë•Œ í•´ë‹¹ ì´ë¯¸ì§€ì— ëŒ€í•œ tagë¥¼ `-t` ì˜µì…˜ìœ¼ë¡œ ë¶€ì—¬í•˜ê³ , ì´í›„ ë„ì»¤ í—ˆë¸Œì— ì´ë¯¸ì§€ë¥¼ push í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
$ docker build -t tiaz0128/fast-api .
```

## docker.com ê°€ì…

[docker.com](https://www.docker.com/){:target="_blank"}ì— ê°€ì…í•˜ê³  ë¡œê·¸ì¸ í•©ë‹ˆë‹¤. ê°€ì… í• ë•Œ ìƒì„±í•˜ëŠ” `Username`ì€ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ë„ì»¤ í—ˆë¸Œ(_Docker Hub_)ì— ì‚¬ìš© ë©ë‹ˆë‹¤.

![Docker Username](/assets/img/content/Docker/001/002.webp){:.img-s}

`> GitHubì™€ ìœ ì‚¬í•œ í˜•íƒœì˜ Docker Hub`{:.img-caption}

## Docker Hub : ì´ë¯¸ì§€ push

Docker HubëŠ” ë¹Œë“œí•œ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ë ˆí¬ì§€í† ë¦¬ ì…ë‹ˆë‹¤. `repositories`{:.path}íƒ­ì—ì„œ Usernameì„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ í•˜ëŠ” ë ˆí¬ì§€í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œëŠ” Public ë ˆí¬ì§€í† ë¦¬ë¥¼ `fast-api`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë§Œë“¤ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ì°¸ê³ ë¡œ ë¹„ê²°ì œ ê³„ì •ë‹¹ í•˜ë‚˜ì˜ Private ë ˆí¬ì§€í† ë¦¬ë¥¼ ì‚¬ìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Docker Username](/assets/img/content/Docker/001/003.webp){:.img-m}

`> Docker Hub : ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ì›ê²© ì €ì¥ì†Œ`{:.img-caption}

### Docker login

ë¹Œë“œí•œ ì´ë¯¸ì§€ë¥¼ ë„ì»¤ í—ˆë¸Œì— push í•˜ê² ìŠµë‹ˆë‹¤. docker.ioì— ë“±ë¡í•œ ì´ë©”ì¼ì´ë‚˜ Usernameìœ¼ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```bash
$ docker login docerk.io

Username: tiaz0128.dev@gmail.com
Password: ****

Login Succeeded
```

### ë¹Œë“œí•œ ì´ë¯¸ì§€ push

ì´ë¯¸ì§€ë¥¼ Docker Hubì— push í•˜ê¸° ìœ„í•´ì„œëŠ” docker.ioì—ì„œ ë“±ë¡ëœ Usernameê³¼ repository ì´ë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ push í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Docker Hubë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ì¼ë°˜ì ìœ¼ë¡œ `Username/repository` í˜•ì‹ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.
ì´ëŠ” Docker Hubê°€ ì‚¬ìš©ìë³„ë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```bash
$ docker push <Username>/<repository>[:tag]

$ docker push tiaz0128/fast-api
```

### Docker tag

`tag` ëª…ë ¹ì–´ëŠ” ë„ì»¤ ì´ë¯¸ì§€ì— íƒœê·¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ë³€ê²½í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ê¸°ë³¸ ì‚¬ìš©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```bash
$ docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]

$ docker tag fast-api:1.0 tiaz0128/fast-api
```

- `SOURCE_IMAGE` : íƒœê·¸ë¥¼ ë³€ê²½í•˜ë ¤ëŠ” ì›ë³¸ ì´ë¯¸ì§€ì˜ ì´ë¦„ê³¼ íƒœê·¸
- `TARGET_IMAGE` : ìƒˆë¡œ ì§€ì •í•  ì´ë¯¸ì§€ ì´ë¦„ê³¼ íƒœê·¸
- `[:TAG]` : ì„ íƒì‚¬í•­, íŠ¹ì • íƒœê·¸ë¥¼ ì§€ì •. ìƒëµí•˜ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ _latest_ ì ìš©

## Docker ìˆ˜ë™ ë°°í¬

ì–´ë–¤ í™˜ê²½ì´ë˜ ì„œë²„ í™˜ê²½ì´ë“  ìƒê´€ì—†ìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” Amazon EC2(_Amazon Linux 2023 AMI_)ì—ì„œ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

### Docker ì„¤ì¹˜

ê°€ì¥ ë¨¼ì € ì„œë²„ì— ë„ì»¤ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```bash
$ sudo yum update -y

$ sudo yum -y install docker
```

### ë°ëª¬ & ê¶Œí•œ ì¶”ê°€

ì„¤ì¹˜ í›„ì—ëŠ” ë°ëª¬ì„ ì‹¤í–‰í•©ë‹ˆë‹¤. í•„ìš”ì‹œ ì‚¬ìš©ì ê·¸ë£¹ ê¶Œí•œì„ ìˆ˜ì • í•´ì¤ë‹ˆë‹¤. ì‚¬ìš©ì(*ec2-user*)ë¥¼ docker ê·¸ë£¹ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ `sudo` ì—†ì´ docker ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

```bash
$ sudo systemctl restart docker

$ sudo usermod -a -G docker ec2-user
```

### Docker pull

ë„ì»¤ í—ˆë¸Œì— ë¡œê·¸ì¸ í•˜ê³  ë¹Œë“œ í•œ ì´ë¯¸ì§€ë¥¼ pull ë°›ìŠµë‹ˆë‹¤.

```bash
$ docker login docerk.io

Username: tiaz0128.dev@gmail.com
Password: ****

Login Succeeded
```

```bash
$ docker pull tiaz0128/fast-api
```

### Docker run & stop

pull ë°›ì€ ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ì •ì§€ í›„, ìƒˆë¡œìš´ ì»¨ë„¤ì´í„°ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜ë™ìœ¼ë¡œ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```bash
$ docker run -it -d --name fast-api --rm tiaz0128/fast-api
```

## ìˆ˜ë™ ë°°í¬ì˜ ë¬¸ì œì 

ì—¬ê¸°ê¹Œì§€ ìˆ˜ë™ìœ¼ë¡œ ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ë°°í¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ì—¬ê¸°ì„œ ì´ëŸ° ìƒê°ì´ ë“­ë‹ˆë‹¤.

> ì½”ë“œê°€ ìˆ˜ì •ë˜ê³  ì´ë¯¸ì§€ê°€ ìƒˆë¡œ ë§Œë“¤ì–´ì§€ë©´ ì–´ë–»ê²Œ í•˜ì§€?

ì•ì„œ í–ˆë˜ ê²ƒì²˜ëŸ¼ ë§¤ë²ˆ ìˆ˜ë™ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ pull ë°›ê³  ì»¨í…Œì´í„°ë¥¼ ì¬ì‹œì‘í•´ì•¼ í•  ê²ƒì…ë‹ˆë‹¤.

ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì—¬ëŸ¬ê°€ì§€ ë°©ë²•ì´ ìˆì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ `Watchtower`ë¥¼ ì‚¬ìš©í•´ ë³´ê² ìŠµë‹ˆë‹¤.

## Watchtower

![Watchtower](/assets/img/content/Docker/001/004.webp){:.img-200x200}

[Watchtower](https://containrrr.dev/watchtower/){:.none target="blank"}ëŠ” ì •ê¸°ì ìœ¼ë¡œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•˜ê³ , ìƒˆ ë²„ì „ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. Watchtower ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ ì‹œì¼œ ë†“ê¸°ë§Œ í•˜ë©´ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ì„œ ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œí•œ í›„, ì²˜ìŒ ë°°í¬ë  ë•Œ ì‚¬ìš©í•œ ë™ì¼ ì˜µì…˜ìœ¼ë¡œ ì¬ì‹œì‘í•©ë‹ˆë‹¤.

### Watchtower ê¸°ë³¸ ì‚¬ìš©ë²•

ì•„ë˜ì˜ ëª…ë ¹ì„ í†µí•´ EC2 ë‚´ë¶€ì— ë™ì‘ ì¤‘ì¸ `fast-api`ë¼ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ëª¨ë‹ˆí„°ë§ í•©ë‹ˆë‹¤. ì—¬ëŸ¬ê°œ ì»¨í…Œì´ë„ˆë¥¼ í•œë²ˆì— ëª¨ë‹ˆí„°ë§ ë˜í•œ ê°€ëŠ¥ í•©ë‹ˆë‹¤.

```bash
$ docker ps

CONTAINER ID   IMAGE                        NAMES
dad54e31fb2b   tiaz0128/fast-api:latest     fast-api
```

```bash
$ docker run -d \
  --name watchtower \
  -v /var/run/docker.sock:/var/run/docker.sock \
  containrrr/watchtower \
  fast-api
```

### Watchtower ì£¼ìš” ì˜µì…˜

- `--interval` : ì—…ë°ì´íŠ¸ í™•ì¸ ì£¼ê¸° ì„¤ì •. ì´ˆë‹¨ìœ„, default: 86400(24H)
- `--schedule` : [6ê°œ í•„ë“œ Cron í‘œí˜„ì‹](https://pkg.go.dev/github.com/robfig/cron@v1.2.0#hdr-CRON_Expression_Format){:.none target="blank"} ì„¤ì •. \-\-interval ì¤‘ì— í•˜ë‚˜ë§Œ ì‚¬ìš© ê°€ëŠ¥
- `--run-once` : ì»¨í…Œì´ë„ˆ ì´ë¦„ ëª©ë¡ì— ëŒ€í•´ ì—…ë°ì´íŠ¸ë¥¼ í•œ ë²ˆë§Œ ì‹œë„í•˜ê³  _Watchtower_ ì¢…ë£Œ

## ë§ˆë¬´ë¦¬

ë¹Œë“œí•œ ì´ë¯¸ì§€ë¥¼ ë„ì»¤ í—ˆë¸Œì— _push_ í•˜ê³  ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Docker EC2ì— ì²˜ìŒì—ëŠ” ìˆ˜ë™ìœ¼ë¡œ ë°°í¬í•´ë³´ê³ , Watchtowerë¥¼ ì´ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ë°°í¬ê¹Œì§€ í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

Watchtowerë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ ì—¬ì „íˆ git ë°°í¬ì™€ ë„ì»¤ ì´ë¯¸ì§€ ë°°í¬ë¥¼ ê°ê° ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ë¶ˆí¸í•¨ì´ ë‚¨ì•„ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²° í•˜ê¸° ìœ„í•´ `GitOps` ë¼ëŠ” ë°©ë²•ë¡ ì´ ë“±ì¥ í•©ë‹ˆë‹¤.

ì´ ë°©ë²•ë¡ ì˜ í•µì‹¬ ì•„ì´ë””ì–´ëŠ” **ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(_single source of truth_)**{:.yellow}ìœ¼ë¡œ git ë ˆí¬ì§€í† ë¦¬ë¥¼ ëª¨ë“  ê²ƒì˜ ê¸°ì¤€ì ìœ¼ë¡œ ì‚¼ëŠ” ê²ƒì…ë‹ˆë‹¤.

{% include template/youtube.html
    url="https://www.youtube.com/embed/iIrk4mqCS78?si=f0ffmUgOuGms8VXi"
%}

`> ë”°ë°° : [ë”°ë°°GitOps] 0. ê°•ì˜ ì†Œê°œ`{:.img-caption}

## ë‹¤ìŒìœ¼ë¡œ

{% include template/alert.html
  type="tip"
  about="ë‹¤ìŒê¸€ì—ì„œ ê³„ì† ë©ë‹ˆë‹¤."
%}

ì´ì œ git ë°°í¬ì™€ ë„ì»¤ ë°°í¬ê¹Œì§€ í•œë²ˆì— í•´ê²°í•  ìˆ˜ ìˆëŠ” ì¢€ ë” ë‚˜ì€ Docker ë°°í¬ ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤! [AWS CodePipeline CI/CD êµ¬ì¶•](/AWS/5){:.none target="_blank"} ë°©ë²•ì„ ê³µë¶€í•´ ë´…ì‹œë‹¤. ğŸ˜Š

## ì°¸ê³  ë¬¸í—Œ

{% include template/ref.html refs=page.ref-link %}
